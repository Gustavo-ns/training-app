<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rutina 30 Minutos - Rastreador</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilo base y fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fondo oscuro */
        }
        .timer-display {
            font-size: 5rem;
            line-height: 1;
            font-weight: 700;
        }
        @media (min-width: 640px) {
            .timer-display {
                font-size: 8rem;
            }
        }
        .work-color { color: #f97316; } /* Naranja/C√°lido para trabajar */
        .rest-color { color: #22c55e; } /* Verde para descansar */
        .ready-color { color: #3b82f6; } /* Azul para preparaci√≥n */
        .finished-color { color: #eab308; } /* Amarillo para terminar */
        
        /* Estilo para el Modal de Reanudaci√≥n */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1f2937; /* Gris oscuro para el modal */
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 400px;
        }
        
        /* Estilos para navegaci√≥n de secciones */
        .section-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .nav-tab {
            transition: all 0.2s ease-in-out;
        }
        
        .nav-tab:hover {
            transform: translateY(-1px);
        }
        
        .hidden {
            display: none !important;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#f97316',
                        'secondary': '#22c55e',
                    }
                }
            }
        }
    </script>
</head>
<body class="text-white min-h-screen p-4 flex flex-col items-center">

    <!-- Encabezado Principal -->
    <header class="text-center mb-6 w-full max-w-lg">
        <h1 class="text-4xl font-extrabold mb-2 bg-gradient-to-r from-orange-500 to-orange-300 bg-clip-text text-transparent">
            Entrenamiento HIIT
        </h1>
        <p id="progress-info" class="text-sm text-gray-400 mt-2">Tu centro de entrenamiento completo</p>
    </header>

    <!-- Navegaci√≥n por Pesta√±as -->
    <nav class="w-full max-w-lg mb-6">
        <div class="flex bg-gray-800 rounded-xl p-1 gap-1">
            <button onclick="showSection('training')" class="nav-tab flex-1 px-3 py-2 rounded-lg text-sm font-medium bg-orange-500 text-white">
                üí™ Entrenar
            </button>
            <button onclick="showSection('calendar')" class="nav-tab flex-1 px-3 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-300">
                üìÖ Calendario
            </button>
            <button onclick="showSection('profile')" class="nav-tab flex-1 px-3 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-300">
                üë§ Perfil
            </button>
            <button onclick="showSection('data')" class="nav-tab flex-1 px-3 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-300">
                üìä Datos
            </button>
        </div>
    </nav>

    <!-- Secci√≥n: ENTRENAR (Activa por defecto) -->
    <section id="section-training" class="section-content w-full max-w-lg">
        <div id="selection-screen" class="space-y-4 w-full mb-8">
            <!-- Informaci√≥n del d√≠a actual -->
            <div class="text-center p-6 bg-gray-800 rounded-xl shadow-lg">
                <div class="mb-4">
                    <h2 class="text-2xl font-bold text-white mb-2" id="today-info">üìÖ Mi√©rcoles</h2>
                    <p class="text-lg text-orange-400 font-semibold" id="todays-routine">Rutina C - Full Body</p>
                    <p class="text-sm text-gray-400 mt-2">Tu entrenamiento de hoy est√° listo</p>
                </div>
            </div>
        
        <!-- Indicador de Carga (Spinner) -->
        <div id="loading-spinner" class="text-center p-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
            <p class="mt-2 text-sm text-gray-400">Conectando con la base de datos...</p>
        </div>

        <!-- Bot√≥n de Inicio del D√≠a -->
        <div id="workout-buttons" class="hidden space-y-4">
            <button onclick="startTodaysWorkout()" class="w-full py-4 rounded-xl bg-primary hover:bg-orange-600 transition-colors shadow-lg font-bold text-lg">
                üöÄ Iniciar Entrenamiento
            </button>
            
            <!-- Bot√≥n secundario para cambiar rutina (opcional) -->
            <button onclick="showRoutineSelector()" class="w-full py-2 text-sm rounded-lg bg-gray-600 hover:bg-gray-500 transition-colors text-gray-300">
                üìã Elegir otra rutina
            </button>
        </div>
    </section>

    <!-- Display del Temporizador (Oculto inicialmente) -->
    <main id="timer-screen" class="hidden flex flex-col items-center justify-center w-full max-w-lg p-6 bg-gray-800 rounded-2xl shadow-2xl transition-all duration-300">
        
        <!-- Nombre de la Fase y Progreso -->
        <div class="mb-4 text-center">
            <p id="phase-title" class="text-xl font-medium ready-color uppercase tracking-widest">CALENTAMIENTO</p>
            <p id="round-info" class="text-md text-gray-400 mt-1"></p>
        </div>

        <!-- Nombre del Ejercicio -->
        <h2 id="exercise-name" class="text-3xl sm:text-4xl text-center font-extrabold text-gray-50 mb-3 min-h-[3rem]">¬°LISTO!</h2>
        
        <!-- Indicador de progreso en la fase (NUEVO) -->
        <div id="phase-progress" class="mb-4 text-center">
            <span id="progress-text" class="text-sm text-gray-500">Prepar√°ndose...</span>
        </div>
        
        <!-- Detalles del Ejercicio (NUEVO) -->
        <div id="exercise-details" class="hidden w-full max-w-lg mx-auto mb-6 p-4 bg-gray-700 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h4 class="text-lg font-semibold text-white">Detalles del Ejercicio</h4>
                <button onclick="hideExerciseDetails()" class="text-gray-400 hover:text-white transition-colors text-xl font-bold" title="Cerrar detalles">√ó</button>
            </div>
            <div class="mb-4">
                <div class="flex flex-wrap gap-2 mb-3">
                    <span id="exercise-category" class="px-2 py-1 text-xs rounded-full bg-blue-500 text-white"></span>
                    <span id="exercise-equipment" class="px-2 py-1 text-xs rounded-full bg-green-500 text-white"></span>
                    <span id="exercise-muscles" class="px-2 py-1 text-xs rounded-full bg-purple-500 text-white"></span>
                </div>
                <p id="exercise-description" class="text-sm text-gray-300 italic mb-3"></p>
            </div>
            
            <div class="space-y-3">
                <div id="exercise-instructions" class="text-sm text-gray-200">
                    <h4 class="font-semibold text-white mb-2">üéØ T√©cnica:</h4>
                    <ol id="instructions-list" class="space-y-1 pl-4"></ol>
                </div>
                
                <div id="exercise-tips" class="text-sm text-gray-200">
                    <h4 class="font-semibold text-white mb-2">üí° Consejos:</h4>
                    <ul id="tips-list" class="space-y-1 pl-4"></ul>
                </div>
            </div>
            
            <button id="toggle-details" onclick="toggleExerciseDetails()" class="mt-3 w-full px-3 py-2 bg-gray-600 text-white text-sm rounded hover:bg-gray-500 transition-colors">
                ‚ñ≤ Ocultar Detalles
            </button>
        </div>

        <!-- Bot√≥n para Mostrar/Ocultar Detalles -->
        <button id="show-details-button" onclick="toggleExerciseDetails()" class="hidden mb-4 px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
            üìã Ver T√©cnica Detallada
        </button>
        
        <!-- Bot√≥n de B√∫squeda de Video -->
        <a id="details-link" target="_blank" class="px-4 py-2 mb-6 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors shadow-md font-medium text-sm hidden">
            üé• Ver Video / T√©cnica
        </a>

        <!-- Temporizador -->
        <div id="timer-box" class="timer-display work-color mb-8 text-gray-500">
            00:00
        </div>
        
        <!-- Mensaje de inicio (NUEVO) -->
        <div id="start-message" class="mb-4 px-4 py-2 bg-green-600 text-white text-sm rounded-lg text-center">
            üöÄ Presiona INICIAR cuando est√©s listo
        </div>
        
        <!-- Indicador de preparaci√≥n (NUEVO) -->
        <div id="preparation-indicator" class="hidden mb-4 px-4 py-2 bg-yellow-600 text-white text-sm rounded-lg">
            üéØ ¬°Prep√°rate! Lee la t√©cnica mientras esperas...
        </div>

        <!-- Botones de Control -->
        <div id="control-buttons" class="flex flex-wrap justify-center gap-4">
            <!-- Bot√≥n de PLAY inicial (solo al comenzar) -->
            <button onclick="startTimer()" id="play-button" class="px-8 py-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-bold text-lg shadow-lg">
                ‚ñ∂Ô∏è INICIAR
            </button>
            
            <!-- Controles completos (ocultos al inicio) -->
            <div id="full-controls" class="hidden flex flex-wrap justify-center gap-4 w-full">
                <button onclick="togglePause()" id="pause-button" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition-colors font-semibold flex-grow sm:flex-grow-0">
                    PAUSAR
                </button>
                <button onclick="nextStep()" class="px-6 py-3 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors shadow-lg font-semibold flex-grow sm:flex-grow-0">
                    ADELANTAR
                </button>
                <button onclick="goBack()" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold flex-grow sm:flex-grow-0">
                    ATRAS
                </button>
                <!-- Bot√≥n para guardado manual -->
                <button onclick="saveProgress('manual')" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold flex-grow sm:flex-grow-0">
                    GUARDAR
                </button>
                <!-- Bot√≥n de Reinicio (oculto, solo para desarrollador/debugging) -->
                <button onclick="resetWorkout()" id="reset-button" class="hidden">REINICIAR</button>
            </div>
            
            <!-- Bot√≥n para volver al inicio (solo cuando termina el entrenamiento) -->
            <button onclick="backToStart()" id="back-to-start-button" class="hidden w-full px-8 py-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-bold text-lg shadow-lg">
                üè† Volver al Inicio
            </button>
        </div>

    </main>

    <!-- Secci√≥n: CALENDARIO -->
    <section id="section-calendar" class="section-content w-full max-w-lg hidden">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">üìÖ Calendario de Entrenamientos</h2>
        
        <!-- Controles del calendario -->
        <div class="flex justify-between items-center mb-4">
            <button onclick="changeCalendarMonth(-1)" class="px-3 py-2 bg-gray-600 hover:bg-gray-500 rounded text-white">‚óÄ Anterior</button>
            <h3 id="calendar-month-year" class="text-lg font-semibold text-white">Octubre 2025</h3>
            <button onclick="changeCalendarMonth(1)" class="px-3 py-2 bg-gray-600 hover:bg-gray-500 rounded text-white">Siguiente ‚ñ∂</button>
        </div>
        
        <!-- D√≠as de la semana -->
        <div class="grid grid-cols-7 gap-1 mb-2">
            <div class="text-center text-xs font-semibold text-gray-400 py-2">Dom</div>
            <div class="text-center text-xs font-semibold text-gray-400 py-2">Lun</div>
            <div class="text-center text-xs font-semibold text-gray-400 py-2">Mar</div>
            <div class="text-center text-xs font-semibold text-gray-400 py-2">Mi√©</div>
            <div class="text-center text-xs font-semibold text-gray-400 py-2">Jue</div>
            <div class="text-center text-xs font-semibold text-gray-400 py-2">Vie</div>
            <div class="text-center text-xs font-semibold text-gray-400 py-2">S√°b</div>
        </div>
        
        <!-- D√≠as del mes -->
        <div id="calendar-days" class="grid grid-cols-7 gap-1">
            <!-- Los d√≠as se generan din√°micamente -->
        </div>
        
        <!-- Estad√≠sticas del mes -->
        <div id="calendar-stats" class="mt-4 p-3 bg-gray-700 rounded-lg">
            <div class="text-sm font-semibold text-white mb-2">üìä Estad√≠sticas del mes</div>
            <div class="grid grid-cols-2 gap-2 text-xs">
                <div>‚úÖ Completados: <span id="completed-count" class="font-semibold text-green-400">0</span></div>
                <div>‚ùå Perdidos: <span id="missed-count" class="font-semibold text-red-400">0</span></div>
                <div>üìà Racha: <span id="streak-count" class="font-semibold text-yellow-400">0 d√≠as</span></div>
                <div>üéØ Porcentaje: <span id="completion-percentage" class="font-semibold text-blue-400">0%</span></div>
            </div>
        </div>
        
        <!-- Leyenda -->
        <div class="mt-4 flex flex-wrap justify-center gap-4 text-xs">
            <div class="flex items-center gap-1">
                <div class="w-4 h-4 bg-green-500 rounded"></div>
                <span class="text-gray-300">Completado</span>
            </div>
            <div class="flex items-center gap-1">
                <div class="w-4 h-4 bg-blue-500 rounded"></div>
                <span class="text-gray-300">Hoy</span>
            </div>
            <div class="flex items-center gap-1">
                <div class="w-4 h-4 bg-red-500 rounded"></div>
                <span class="text-gray-300">Perdido</span>
            </div>
            <div class="flex items-center gap-1">
                <div class="w-4 h-4 bg-gray-600 rounded"></div>
                <span class="text-gray-300">Futuro</span>
            </div>
        </div>
    </section>

    <!-- Secci√≥n: PERFIL -->
    <section id="section-profile" class="section-content w-full max-w-lg hidden">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">üë§ Perfil de Usuario</h2>
        
        <!-- Datos b√°sicos del usuario -->
        <div id="user-profile-display" class="mb-4 p-3 bg-gray-700 rounded-lg">
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div>üìè Altura: <span id="display-height" class="font-semibold text-blue-400">- cm</span></div>
                <div>‚öñÔ∏è Peso: <span id="display-weight" class="font-semibold text-green-400">- kg</span></div>
                <div>üéÇ Edad: <span id="display-age" class="font-semibold text-yellow-400">- a√±os</span></div>
                <div>‚ö° Actividad: <span id="display-activity" class="font-semibold text-purple-400">-</span></div>
            </div>
            <div class="mt-2 text-center">
                <div class="text-lg font-bold">
                    üìä IMC: <span id="display-bmi" class="text-orange-400">-</span>
                    <span id="display-bmi-category" class="text-xs text-gray-400 ml-2">(-)</span>
                </div>
            </div>
        </div>

        <!-- Bot√≥n para editar perfil -->
        <button onclick="toggleProfileEditor()" id="edit-profile-btn" class="w-full mb-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
            ‚úèÔ∏è Editar Perfil
        </button>

        <!-- Formulario de edici√≥n (oculto por defecto) -->
        <div id="profile-editor" class="hidden mb-4 p-4 bg-gray-700 rounded-lg">
            <h3 class="font-semibold mb-3 text-white">Informaci√≥n Personal</h3>
            
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Altura (cm)</label>
                    <input type="number" id="input-height" placeholder="170" min="100" max="250"
                           class="w-full px-2 py-1 text-sm bg-gray-600 text-white rounded border border-gray-500 focus:border-blue-400 focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Peso actual (kg)</label>
                    <input type="number" id="input-weight" placeholder="70" min="30" max="300" step="0.1"
                           class="w-full px-2 py-1 text-sm bg-gray-600 text-white rounded border border-gray-500 focus:border-blue-400 focus:outline-none">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Edad (a√±os)</label>
                    <input type="number" id="input-age" placeholder="25" min="13" max="100"
                           class="w-full px-2 py-1 text-sm bg-gray-600 text-white rounded border border-gray-500 focus:border-blue-400 focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Sexo</label>
                    <select id="input-gender" class="w-full px-2 py-1 text-sm bg-gray-600 text-white rounded border border-gray-500 focus:border-blue-400 focus:outline-none">
                        <option value="">Seleccionar</option>
                        <option value="male">Masculino</option>
                        <option value="female">Femenino</option>
                        <option value="other">Otro</option>
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <label class="block text-xs text-gray-400 mb-1">Nivel de Actividad F√≠sica</label>
                <select id="input-activity" class="w-full px-2 py-1 text-sm bg-gray-600 text-white rounded border border-gray-500 focus:border-blue-400 focus:outline-none">
                    <option value="">Seleccionar nivel</option>
                    <option value="sedentary">Sedentario (poco o ning√∫n ejercicio)</option>
                    <option value="light">Ligero (ejercicio ligero 1-3 d√≠as/semana)</option>
                    <option value="moderate">Moderado (ejercicio moderado 3-5 d√≠as/semana)</option>
                    <option value="active">Activo (ejercicio intenso 6-7 d√≠as/semana)</option>
                    <option value="very-active">Muy activo (ejercicio muy intenso, trabajo f√≠sico)</option>
                </select>
            </div>

            <div class="flex gap-2">
                <button onclick="saveUserProfile()" class="flex-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded transition-colors">
                    üíæ Guardar
                </button>
                <button onclick="toggleProfileEditor()" class="flex-1 px-3 py-2 bg-gray-600 hover:bg-gray-500 text-white text-sm rounded transition-colors">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>

        <!-- Historial de Peso -->
        <div class="mb-4">
            <h3 class="font-semibold mb-2 text-white">üìà Historial de Peso</h3>
            
            <!-- Gr√°fico de Barras del Peso -->
            <div class="mb-4 bg-gray-700 rounded-lg p-3">
                <canvas id="weight-chart" width="400" height="200"></canvas>
                <p id="weight-chart-message" class="text-center text-gray-400 text-sm mt-2">Agrega mediciones de peso para ver el gr√°fico</p>
            </div>
            
            <!-- A√±adir nueva medici√≥n -->
            <div class="flex gap-2 mb-3">
                <input type="number" id="new-weight" placeholder="Peso (kg)" step="0.1" min="30" max="300"
                       class="flex-1 px-2 py-1 text-sm bg-gray-600 text-white rounded border border-gray-500 focus:border-blue-400 focus:outline-none">
                <button onclick="addWeightEntry()" class="px-3 py-1 bg-orange-600 hover:bg-orange-700 text-white text-sm rounded transition-colors">
                    ‚ûï Agregar
                </button>
            </div>

            <!-- Lista del historial de peso -->
            <div id="weight-history" class="max-h-40 overflow-y-auto bg-gray-700 rounded p-2">
                <p class="text-gray-400 text-xs">No hay registros de peso a√∫n</p>
            </div>
        </div>
    </section>

    <!-- Secci√≥n: DATOS -->
    <section id="section-data" class="section-content w-full max-w-lg hidden">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">üìä Gesti√≥n de Datos</h2>
        
        <!-- Historial de Entrenamientos -->
        <div class="mb-6 p-4 bg-gray-700 rounded-lg">
            <h3 class="text-lg font-bold mb-3 text-gray-100">Historial de Entrenamientos</h3>
        <div id="history-list" class="space-y-2 max-h-60 overflow-y-auto">
            <p class="text-gray-400" id="loading-history">Cargando historial...</p>
        </div>
        
        <!-- Gesti√≥n de Usuario -->
        <div class="mb-6 p-4 bg-gray-700 rounded-lg">
            <h3 class="text-lg font-bold mb-3 text-gray-100">üë§ Gesti√≥n de Usuario</h3>
            <p class="text-sm text-gray-400 mb-2">ID de Usuario: <span id="user-id" class="text-white font-semibold">Cargando...</span></p>
            <div class="flex gap-2 mb-2">
                <input type="text" id="custom-user-id" placeholder="Personalizar ID (ej: juan-2025)" 
                       class="flex-1 px-3 py-2 text-sm bg-gray-600 text-white rounded border border-gray-500 focus:border-blue-400 focus:outline-none">
                <button onclick="changeUserId()" class="px-3 py-2 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition-colors">
                    üíæ Cambiar ID
                </button>
            </div>
        </div>
        
        <!-- Herramientas de Datos -->
        <div class="p-4 bg-gray-700 rounded-lg">
            <h3 class="text-lg font-bold mb-3 text-gray-100">üîß Herramientas</h3>
            <div class="text-center space-y-2">
                <button onclick="testFirebaseConnection()" class="w-full px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
                    üîß Probar Conexi√≥n Firebase
                </button>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="downloadDataAsJSON()" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors">
                        üì• Descargar
                    </button>
                    <label for="json-file-import" class="px-3 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition-colors cursor-pointer text-center">
                        üì§ Importar
                    </label>
                    <button onclick="clearAllData()" class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors">
                        üóëÔ∏è Limpiar
                    </button>
                </div>
                <input type="file" id="json-file-import" accept=".json" style="display: none;" onchange="handleJSONImport(event)">
            </div>
        </div>
    </section>

    <!-- Modal de Confirmaci√≥n de Reanudaci√≥n de Progreso -->
    <div id="resume-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h3 class="text-xl font-bold mb-4 text-white">Progreso Encontrado</h3>
            <p id="modal-message" class="text-gray-300 mb-6">Se encontr√≥ progreso de una rutina anterior.</p>
            <div class="flex justify-around space-x-4">
                <button id="resume-button" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-semibold">
                    REANUDAR
                </button>
                <button onclick="continueWithoutResume()" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-semibold">
                    COMENZAR NUEVA
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- NAVEGACI√ìN ENTRE SECCIONES (GLOBAL) ---
        function showSection(sectionName) {
            // Ocultar todas las secciones
            const sections = document.querySelectorAll('.section-content');
            sections.forEach(section => section.classList.add('hidden'));
            
            // Remover clase activa de todos los botones de navegaci√≥n
            const navButtons = document.querySelectorAll('.nav-tab');
            navButtons.forEach(btn => {
                btn.classList.remove('bg-orange-500', 'text-white');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            });
            
            // Mostrar la secci√≥n seleccionada
            const targetSection = document.getElementById(`section-${sectionName}`);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Activar el bot√≥n de navegaci√≥n correspondiente
            const activeButton = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
            if (activeButton) {
                activeButton.classList.remove('bg-gray-700', 'text-gray-300');
                activeButton.classList.add('bg-orange-500', 'text-white');
            }
            
            // Acciones espec√≠ficas por secci√≥n
            if (sectionName === 'profile') {
                // Actualizar gr√°fico de peso cuando se muestra la secci√≥n de perfil
                setTimeout(() => {
                    updateWeightChart();
                }, 100); // Peque√±o delay para asegurar que el canvas est√© visible
            }
        }
        
        // Mostrar secci√≥n de entrenamiento por defecto al cargar
        document.addEventListener('DOMContentLoaded', function() {
            showSection('training');
        });
        
        // Hacer la funci√≥n global para que est√© disponible desde el m√≥dulo
        window.showSection = showSection;
    </script>

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, setLogLevel, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configuraci√≥n y Variables Globales de Firebase (Proporcionadas por el entorno Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Configuraci√≥n de Firebase con fallback para desarrollo local
        let firebaseConfig = {};
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            // CONFIGURACI√ìN DE PRUEBA PARA DESARROLLO LOCAL
            // 
            // üî• PASOS PARA CONFIGURAR FIREBASE:
            // 1. Ve a https://console.firebase.google.com/
            // 2. Crea un nuevo proyecto (o usa uno existente)
            // 3. Ve a "Configuraci√≥n del proyecto" > "General"
            // 4. En "Tus apps", selecciona "Web" (</>)
            // 5. Registra tu app y copia la configuraci√≥n
            // 6. Habilita Authentication > Sign-in method > Anonymous
            // 7. Habilita Firestore Database con reglas de prueba
            // 
            // ‚ö†Ô∏è  REEMPLAZA ESTOS VALORES CON TU CONFIGURACI√ìN REAL DE FIREBASE ‚ö†Ô∏è
            firebaseConfig = {
                // Descomenta y completa estos campos con tu configuraci√≥n real:
                /*
                apiKey: "tu-api-key-aqui",
                authDomain: "tu-proyecto.firebaseapp.com",
                projectId: "tu-proyecto-id",
                storageBucket: "tu-proyecto.appspot.com",
                messagingSenderId: "123456789",
                appId: "1:123456789:web:abcdef123456"
                */
            };
            
            console.warn("üîß USANDO CONFIGURACI√ìN DE DESARROLLO LOCAL");
            console.warn("Para habilitar Firebase, edita las l√≠neas 172-179 con tu configuraci√≥n real.");
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Instancias de Firebase
        let app, db, auth;
        let userId = 'anonymous';
        let isAuthReady = false;

        // --- CONFIGURACI√ìN DE RUTINAS Y TIEMPOS ---
        const WORK_TIME = 45; // Segundos de trabajo para Circuito A/B
        const REST_TIME = 15; // Segundos de descanso para Circuito A/B
        const CORE_WORK_TIME = 45; // Usamos 45/15 para Core tambi√©n por consistencia de ritmo
        const CORE_REST_TIME = 15;
        const ROUNDS = 4; // 4 rondas para todos los circuitos

        // --- BASE DE DATOS DE EJERCICIOS CON DESCRIPCIONES DETALLADAS ---
        const EXERCISE_DATABASE = {
            // CALENTAMIENTO
            "Marcha en el sitio / Trote Suave": {
                category: "calentamiento",
                equipment: "ninguno",
                muscles: ["piernas", "cardiovascular"],
                description: "Movimiento suave para activar la circulaci√≥n y preparar el cuerpo",
                instructions: [
                    "1. P√°rate derecho con los pies separados al ancho de las caderas",
                    "2. Eleva alternadamente las rodillas hasta la altura de la cadera",
                    "3. Balancea los brazos naturalmente",
                    "4. Mant√©n el torso erguido y respira profundamente",
                    "5. Aumenta gradualmente la intensidad"
                ],
                tips: [
                    "‚úÖ Aterriza suavemente en la parte media del pie",
                    "‚úÖ Mant√©n los hombros relajados",
                    "‚ö†Ô∏è No saltes demasiado alto al principio"
                ]
            },
            "C√≠rculos de brazos (adelante y atr√°s)": {
                category: "calentamiento",
                equipment: "ninguno",
                muscles: ["hombros", "brazos"],
                description: "Movilizaci√≥n articular para preparar hombros y brazos",
                instructions: [
                    "1. P√°rate con los pies separados al ancho de hombros",
                    "2. Extiende los brazos a los lados, paralelos al suelo",
                    "3. Realiza c√≠rculos peque√±os hacia adelante 15 segundos",
                    "4. Cambia direcci√≥n hacia atr√°s otros 15 segundos",
                    "5. Aumenta gradualmente el tama√±o de los c√≠rculos"
                ],
                tips: [
                    "‚úÖ Mant√©n los brazos extendidos pero no r√≠gidos",
                    "‚úÖ Control el movimiento, no uses impulso",
                    "‚ö†Ô∏è Si sientes dolor, reduce el rango de movimiento"
                ]
            },
            "Oscilaci√≥n de piernas (adelante y lados)": {
                category: "calentamiento",
                equipment: "ninguno",
                muscles: ["cadera", "piernas"],
                description: "Movilizaci√≥n de cadera y piernas para mejorar flexibilidad",
                instructions: [
                    "1. Ap√≥yate en una pared o superficie para mantener equilibrio",
                    "2. Balancea una pierna hacia adelante y atr√°s 10 veces",
                    "3. Luego balancea la misma pierna hacia los lados 10 veces",
                    "4. Cambia de pierna y repite",
                    "5. Mant√©n el torso erguido durante todo el movimiento"
                ],
                tips: [
                    "‚úÖ Movimiento controlado, no uses impulso",
                    "‚úÖ Aumenta gradualmente el rango de movimiento",
                    "‚ö†Ô∏è No fuerces el estiramiento"
                ]
            },
            "Sentadillas corporales (lentas)": {
                category: "calentamiento",
                equipment: "ninguno",
                muscles: ["piernas", "gl√∫teos"],
                description: "Preparaci√≥n suave para ejercicios de piernas m√°s intensos",
                instructions: [
                    "1. P√°rate con pies al ancho de hombros",
                    "2. Baja lentamente a posici√≥n de sentadilla",
                    "3. Mant√©n el pecho erguido y peso en los talones",
                    "4. Sube lentamente a la posici√≥n inicial",
                    "5. Enf√≥cate en la t√©cnica, no en la velocidad"
                ],
                tips: [
                    "‚úÖ Movimiento lento y controlado",
                    "‚úÖ Respira profundamente durante el movimiento",
                    "‚ö†Ô∏è No bajes m√°s de lo que te sea c√≥modo"
                ]
            },
            "Rotaci√≥n de torso suave": {
                category: "calentamiento",
                equipment: "ninguno",
                muscles: ["core", "espalda"],
                description: "Moviliza la columna y prepara el core",
                instructions: [
                    "1. P√°rate con pies al ancho de hombros",
                    "2. Coloca las manos en las caderas o cruza sobre el pecho",
                    "3. Gira suavemente el torso hacia la derecha",
                    "4. Regresa al centro y gira hacia la izquierda",
                    "5. Mant√©n las caderas mirando hacia adelante"
                ],
                tips: [
                    "‚úÖ Movimiento suave y controlado",
                    "‚úÖ Mant√©n las caderas estables",
                    "‚ö†Ô∏è No fuerces la rotaci√≥n"
                ]
            },
            // ESTIRAMIENTOS (COOLDOWN)
            "Estiramiento de Cu√°driceps (30s c/lado)": {
                category: "estiramiento",
                equipment: "ninguno",
                muscles: ["cu√°driceps"],
                description: "Estira los m√∫sculos frontales del muslo",
                instructions: [
                    "1. P√°rate derecho, usa pared para apoyo si necesario",
                    "2. Flexiona la rodilla llevando el tal√≥n hacia el gl√∫teo",
                    "3. Sost√©n el pie con la mano del mismo lado",
                    "4. Mant√©n las rodillas juntas y caderas hacia adelante",
                    "5. Mant√©n 30 segundos, cambia de lado"
                ],
                tips: [
                    "‚úÖ Mant√©n las rodillas juntas",
                    "‚úÖ No tires fuerte del pie",
                    "‚ö†Ô∏è Si no puedes alcanzar el pie, usa una toalla"
                ]
            },
            "Estiramiento de Isquiotibiales (toca pies)": {
                category: "estiramiento",
                equipment: "ninguno",
                muscles: ["isquiotibiales", "espalda baja"],
                description: "Estira la parte posterior de las piernas",
                instructions: [
                    "1. P√°rate con pies juntos o ligeramente separados",
                    "2. Baja lentamente llevando las manos hacia los pies",
                    "3. Mant√©n las piernas rectas o ligeramente flexionadas",
                    "4. Respira profundamente y rel√°jate en la posici√≥n",
                    "5. Sube lentamente enrollando la columna"
                ],
                tips: [
                    "‚úÖ No rebotes, mant√©n el estiramiento est√°tico",
                    "‚úÖ Flexiona ligeramente las rodillas si es necesario",
                    "‚ö†Ô∏è No fuerces si tienes problemas de espalda"
                ]
            },
            "Estiramiento de Pecho (manos atr√°s)": {
                category: "estiramiento",
                equipment: "ninguno",
                muscles: ["pecho", "hombros"],
                description: "Estira los m√∫sculos del pecho y mejora la postura",
                instructions: [
                    "1. P√°rate derecho con pies al ancho de hombros",
                    "2. Entrelaza los dedos detr√°s de la espalda",
                    "3. Endereza los brazos y lev√°ntalos ligeramente",
                    "4. Saca el pecho y aprieta los om√≥platos",
                    "5. Mant√©n la posici√≥n respirando profundamente"
                ],
                tips: [
                    "‚úÖ Mant√©n los hombros relajados",
                    "‚úÖ Respira profundamente",
                    "‚ö†Ô∏è No fuerces si tienes problemas de hombro"
                ]
            },
            "Estiramiento de Hombro (brazo cruzado)": {
                category: "estiramiento",
                equipment: "ninguno",
                muscles: ["hombros", "brazos"],
                description: "Estira los m√∫sculos del hombro y la parte posterior del brazo",
                instructions: [
                    "1. Extiende el brazo derecho cruz√°ndolo sobre el pecho",
                    "2. Con el brazo izquierdo, tira suavemente del codo derecho",
                    "3. Mant√©n el hombro relajado y hacia abajo",
                    "4. Mant√©n 30 segundos, cambia de brazo",
                    "5. Respira normalmente durante el estiramiento"
                ],
                tips: [
                    "‚úÖ Tira suavemente, no uses fuerza",
                    "‚úÖ Mant√©n los hombros relajados",
                    "‚ö†Ô∏è No tires del hombro hacia arriba"
                ]
            },
            "Descanso de Recuperaci√≥n": {
                category: "descanso",
                equipment: "ninguno",
                muscles: ["recuperaci√≥n"],
                description: "Tiempo para recuperarse entre ejercicios intensos",
                instructions: [
                    "1. Respira profundamente y de manera controlada",
                    "2. Camina suavemente en el sitio si lo necesitas",
                    "3. Mantente hidratado con peque√±os sorbos de agua",
                    "4. Relaja los m√∫sculos que han estado trabajando",
                    "5. Prep√°rate mentalmente para el siguiente ejercicio"
                ],
                tips: [
                    "‚úÖ No te sientes completamente, mantente activo",
                    "‚úÖ Respira profundamente para reducir la frecuencia card√≠aca",
                    "‚ö†Ô∏è Si sientes mareo, si√©ntate y descansa m√°s tiempo"
                ]
            },
            
            // CIRCUITO A
            "Sentadilla Goblet (12kg)": {
                category: "fuerza",
                equipment: "mancuerna 12kg",
                muscles: ["cu√°driceps", "gl√∫teos", "core"],
                description: "Ejercicio fundamental para fortalecer piernas y gl√∫teos",
                instructions: [
                    "1. Sost√©n la mancuerna con ambas manos contra el pecho",
                    "2. Pies separados al ancho de hombros, dedos ligeramente hacia afuera",
                    "3. Baja manteniendo el pecho erguido hasta que los muslos est√©n paralelos",
                    "4. Empuja desde los talones para volver a la posici√≥n inicial",
                    "5. Mant√©n las rodillas alineadas con los dedos de los pies"
                ],
                tips: [
                    "‚úÖ El peso est√° en los talones, no en las puntas",
                    "‚úÖ Mant√©n el core contra√≠do durante todo el movimiento",
                    "‚ö†Ô∏è No dejes que las rodillas se vayan hacia adentro",
                    "‚ö†Ô∏è No bajes m√°s de lo que tu flexibilidad permita"
                ]
            },
            "Remo a una mano (12kg)": {
                category: "fuerza",
                equipment: "mancuerna 12kg",
                muscles: ["espalda", "b√≠ceps", "core"],
                description: "Fortalece la espalda y mejora la postura",
                instructions: [
                    "1. Apoya rodilla y mano izquierda en un banco o superficie",
                    "2. Pie derecho firme en el suelo, torso paralelo al suelo",
                    "3. Sost√©n la mancuerna con el brazo derecho extendido",
                    "4. Tira del codo hacia atr√°s, llevando la mancuerna hacia las costillas",
                    "5. Baja controladamente y repite. Cambia de lado."
                ],
                tips: [
                    "‚úÖ Aprieta el om√≥plato hacia la columna al subir",
                    "‚úÖ Mant√©n la espalda recta durante todo el movimiento",
                    "‚ö†Ô∏è No uses impulso ni balancees el torso",
                    "‚ö†Ô∏è No dejes caer el hombro del brazo que trabaja"
                ]
            },
            "Zancada Inversa (12kg)": {
                category: "fuerza",
                equipment: "mancuerna 12kg",
                muscles: ["cu√°driceps", "gl√∫teos", "isquiotibiales"],
                description: "Ejercicio unilateral que mejora fuerza y equilibrio",
                instructions: [
                    "1. P√°rate derecho sosteniendo mancuernas a los lados",
                    "2. Da un paso largo hacia atr√°s con el pie derecho",
                    "3. Baja hasta que la rodilla trasera casi toque el suelo",
                    "4. Empuja desde el tal√≥n delantero para volver al inicio",
                    "5. Alterna las piernas o completa todas las repeticiones de un lado"
                ],
                tips: [
                    "‚úÖ Mant√©n el torso erguido durante todo el movimiento",
                    "‚úÖ El 70% del peso debe estar en la pierna delantera",
                    "‚ö†Ô∏è No dejes que la rodilla delantera pase la punta del pie",
                    "‚ö†Ô∏è No apoyes el peso en la pierna trasera"
                ]
            },
            
            // CIRCUITO B
            "Peso Muerto Rumano (12kg)": {
                category: "fuerza",
                equipment: "mancuerna 12kg",
                muscles: ["isquiotibiales", "gl√∫teos", "espalda baja"],
                description: "Fortalece la cadena posterior y mejora la flexibilidad",
                instructions: [
                    "1. Sost√©n mancuernas frente a los muslos, pies al ancho de caderas",
                    "2. Mant√©n las rodillas ligeramente flexionadas",
                    "3. Empuja las caderas hacia atr√°s y baja las mancuernas",
                    "4. Baja hasta sentir estiramiento en isquiotibiales",
                    "5. Empuja las caderas hacia adelante para volver al inicio"
                ],
                tips: [
                    "‚úÖ Mant√©n la espalda recta, pecho hacia afuera",
                    "‚úÖ Las mancuernas deben mantenerse cerca del cuerpo",
                    "‚ö†Ô∏è No redondees la espalda",
                    "‚ö†Ô∏è El movimiento viene de las caderas, no de las rodillas"
                ]
            },
            "Plancha (Plank)": {
                category: "core",
                equipment: "ninguno",
                muscles: ["core", "hombros", "gl√∫teos"],
                description: "Ejercicio isom√©trico que fortalece todo el core",
                instructions: [
                    "1. Col√≥cate en posici√≥n de flexi√≥n de brazos",
                    "2. Apoya los antebrazos en el suelo, codos bajo los hombros",
                    "3. Mant√©n el cuerpo en l√≠nea recta desde cabeza hasta talones",
                    "4. Contrae el abdomen y los gl√∫teos",
                    "5. Mant√©n la posici√≥n respirando normalmente"
                ],
                tips: [
                    "‚úÖ Mant√©n la mirada hacia el suelo para proteger el cuello",
                    "‚úÖ Respira normalmente, no contengas la respiraci√≥n",
                    "‚ö†Ô∏è No levantes las caderas demasiado",
                    "‚ö†Ô∏è No dejes que las caderas se hundan"
                ]
            },
            "Press de Hombro (12kg)": {
                category: "fuerza",
                equipment: "mancuerna 12kg",
                muscles: ["hombros", "tr√≠ceps", "core"],
                description: "Fortalece los hombros y mejora la estabilidad del core",
                instructions: [
                    "1. P√°rate con los pies al ancho de hombros",
                    "2. Sost√©n las mancuernas a la altura de los hombros",
                    "3. Palmas mirando hacia adelante, codos hacia abajo",
                    "4. Empuja las mancuernas hacia arriba hasta extender los brazos",
                    "5. Baja controladamente a la posici√≥n inicial"
                ],
                tips: [
                    "‚úÖ Mant√©n el core contra√≠do para proteger la espalda baja",
                    "‚úÖ No arque√©s excesivamente la espalda",
                    "‚ö†Ô∏è No choques las mancuernas arriba",
                    "‚ö†Ô∏è No bajes m√°s all√° de la altura de los hombros"
                ]
            },
            "Burpees sin Salto": {
                category: "cardio",
                equipment: "ninguno",
                muscles: ["todo el cuerpo"],
                description: "Ejercicio cardiovascular de cuerpo completo de bajo impacto",
                instructions: [
                    "1. P√°rate derecho con los pies al ancho de hombros",
                    "2. Ag√°chate y coloca las manos en el suelo",
                    "3. Da un paso hacia atr√°s con cada pie para quedar en plancha",
                    "4. Da un paso hacia adelante con cada pie",
                    "5. Lev√°ntate y estira los brazos hacia arriba"
                ],
                tips: [
                    "‚úÖ Mant√©n el core contra√≠do en la posici√≥n de plancha",
                    "‚úÖ Movimientos controlados, no te apresures",
                    "‚ö†Ô∏è No dejes que las caderas se hundan en la plancha",
                    "‚ö†Ô∏è Si tienes problemas de mu√±eca, usa pu√±os cerrados"
                ]
            },
            "Dumbbell Thrusters (12kg)": {
                category: "fuerza",
                equipment: "mancuerna 12kg",
                muscles: ["piernas", "hombros", "core"],
                description: "Ejercicio compuesto que combina sentadilla con press de hombro",
                instructions: [
                    "1. Sost√©n las mancuernas a la altura de los hombros",
                    "2. Realiza una sentadilla completa",
                    "3. Al subir de la sentadilla, usa el impulso para presionar las mancuernas arriba",
                    "4. Baja las mancuernas mientras desciendes a la siguiente sentadilla",
                    "5. Mant√©n un ritmo fluido y controlado"
                ],
                tips: [
                    "‚úÖ Usa el impulso de las piernas para ayudar al press",
                    "‚úÖ Mant√©n el torso erguido durante todo el movimiento",
                    "‚ö†Ô∏è No pares entre la sentadilla y el press",
                    "‚ö†Ô∏è No arque√©s la espalda al presionar arriba"
                ]
            },
            "Mountain Climbers": {
                category: "cardio",
                equipment: "ninguno",
                muscles: ["core", "hombros", "piernas"],
                description: "Ejercicio cardiovascular que fortalece el core y mejora la coordinaci√≥n",
                instructions: [
                    "1. Comienza en posici√≥n de plancha alta (brazos extendidos)",
                    "2. Lleva la rodilla derecha hacia el codo derecho",
                    "3. Regresa la pierna derecha y lleva la rodilla izquierda hacia el codo izquierdo",
                    "4. Alterna las piernas manteniendo un ritmo constante",
                    "5. Mant√©n las caderas estables durante todo el movimiento"
                ],
                tips: [
                    "‚úÖ Mant√©n las manos firmes y los hombros sobre las mu√±ecas",
                    "‚úÖ Respira de manera constante y controlada",
                    "‚ö†Ô∏è No levantes las caderas demasiado",
                    "‚ö†Ô∏è No hagas el movimiento demasiado r√°pido si pierdes la forma"
                ]
            },
            "Elevaci√≥n de Talones (12kg)": {
                category: "fuerza",
                equipment: "mancuerna 12kg",
                muscles: ["pantorrillas"],
                description: "Fortalece los m√∫sculos de las pantorrillas",
                instructions: [
                    "1. P√°rate derecho sosteniendo las mancuernas a los lados",
                    "2. Pies separados al ancho de caderas, paralelos",
                    "3. Lev√°ntate sobre las puntas de los pies lo m√°s alto posible",
                    "4. Mant√©n la posici√≥n por un momento",
                    "5. Baja controladamente hasta apoyar totalmente los pies"
                ],
                tips: [
                    "‚úÖ Mant√©n el equilibrio, usa una pared si es necesario",
                    "‚úÖ Haz el movimiento completo, desde abajo hasta arriba",
                    "‚ö†Ô∏è No rebotes en la parte inferior",
                    "‚ö†Ô∏è No te inclines hacia adelante o atr√°s"
                ]
            },
            // EJERCICIOS DE CORE
            "Crunches (Encogimientos)": {
                category: "core",
                equipment: "ninguno",
                muscles: ["abdomen"],
                description: "Ejercicio b√°sico para fortalecer los m√∫sculos abdominales",
                instructions: [
                    "1. Acu√©state boca arriba con las rodillas flexionadas",
                    "2. Pies apoyados en el suelo, manos detr√°s de la cabeza",
                    "3. Contrae el abdomen y levanta los hombros del suelo",
                    "4. Mant√©n por un momento y baja controladamente",
                    "5. No tires del cuello con las manos"
                ],
                tips: [
                    "‚úÖ El movimiento viene del abdomen, no del cuello",
                    "‚úÖ Exhala al subir, inhala al bajar",
                    "‚ö†Ô∏è No tires de la cabeza con las manos",
                    "‚ö†Ô∏è No necesitas levantarte completamente"
                ]
            },
            "Abdominales Bicicleta": {
                category: "core",
                equipment: "ninguno",
                muscles: ["abdomen", "oblicuos"],
                description: "Ejercicio din√°mico que trabaja el abdomen y los oblicuos",
                instructions: [
                    "1. Acu√©state boca arriba, manos detr√°s de la cabeza",
                    "2. Levanta las piernas con rodillas flexionadas a 90¬∞",
                    "3. Lleva el codo derecho hacia la rodilla izquierda",
                    "4. Alterna llevando el codo izquierdo hacia la rodilla derecha",
                    "5. Mant√©n un ritmo controlado como si pedaleases"
                ],
                tips: [
                    "‚úÖ Mant√©n la espalda baja pegada al suelo",
                    "‚úÖ Controla el movimiento, no uses impulso",
                    "‚ö†Ô∏è No tires del cuello",
                    "‚ö†Ô∏è No dejes que los pies toquen el suelo"
                ]
            },
            "Elevaci√≥n de piernas": {
                category: "core",
                equipment: "ninguno",
                muscles: ["abdomen bajo"],
                description: "Ejercicio que fortalece especialmente la parte baja del abdomen",
                instructions: [
                    "1. Acu√©state boca arriba con las piernas extendidas",
                    "2. Manos a los lados del cuerpo o bajo la espalda baja",
                    "3. Levanta las piernas juntas hasta formar 90¬∞ con el torso",
                    "4. Baja las piernas controladamente sin tocar el suelo",
                    "5. Mant√©n la espalda baja pegada al suelo"
                ],
                tips: [
                    "‚úÖ Si es muy dif√≠cil, flexiona ligeramente las rodillas",
                    "‚úÖ Baja las piernas solo hasta donde puedas controlar",
                    "‚ö†Ô∏è No arquees la espalda baja",
                    "‚ö†Ô∏è No uses impulso para subir las piernas"
                ]
            },
            "Plancha Lateral (Lado 1 y 2 - 22s c/u)": {
                category: "core",
                equipment: "ninguno",
                muscles: ["oblicuos", "core"],
                description: "Ejercicio isom√©trico que fortalece los m√∫sculos laterales del core",
                instructions: [
                    "1. Acu√©state de lado, ap√≥yate en el antebrazo",
                    "2. Codo directamente bajo el hombro",
                    "3. Levanta las caderas formando una l√≠nea recta",
                    "4. Mant√©n 22 segundos, luego cambia de lado",
                    "5. Mant√©n la cabeza alineada con la columna"
                ],
                tips: [
                    "‚úÖ Aprieta el abdomen y los gl√∫teos",
                    "‚úÖ Respira normalmente mientras mantienes la posici√≥n",
                    "‚ö†Ô∏è No dejes que las caderas se hundan",
                    "‚ö†Ô∏è No ruedes hacia adelante o atr√°s"
                ]
            }
        };

        const WORKOUT_STRUCTURE = {
            WARMUP: [
                { name: "Marcha en el sitio / Trote Suave", duration: 60, isRest: false, style: 'ready-color' },
                { name: "C√≠rculos de brazos (adelante y atr√°s)", duration: 60, isRest: false, style: 'ready-color' },
                { name: "Oscilaci√≥n de piernas (adelante y lados)", duration: 60, isRest: false, style: 'ready-color' },
                { name: "Sentadillas corporales (lentas)", duration: 60, isRest: false, style: 'ready-color' },
                { name: "Rotaci√≥n de torso suave", duration: 60, isRest: false, style: 'ready-color' },
            ],

            COOLDOWN: [
                { name: "Estiramiento de Cu√°driceps (30s c/lado)", duration: 60, isRest: false, style: 'ready-color' },
                { name: "Estiramiento de Isquiotibiales (toca pies)", duration: 60, isRest: false, style: 'ready-color' },
                { name: "Estiramiento de Pecho (manos atr√°s)", duration: 60, isRest: false, style: 'ready-color' },
                { name: "Estiramiento de Hombro (brazo cruzado)", duration: 60, isRest: false, style: 'ready-color' },
                { name: "¬°Entrenamiento Terminado!", duration: 60, isRest: false, style: 'finished-color' },
            ],

            CIRCUITO_A_EXERCISES: [
                "Sentadilla Goblet (12kg)",
                "Remo a una mano (12kg)",
                "Zancada Inversa (12kg)",
                "Press de Hombro (12kg)",
                "Burpees sin Salto",
            ],

            CIRCUITO_B_EXERCISES: [
                "Peso Muerto Rumano (12kg)",
                "Dumbbell Thrusters (12kg)",
                "Plancha (Plank)",
                "Elevaci√≥n de Talones (12kg)",
                "Mountain Climbers",
            ],

            CORE_EXERCISES: [
                "Crunches (Encogimientos)",
                "Abdominales Bicicleta",
                "Elevaci√≥n de piernas",
                "Plancha Lateral (Lado 1 y 2 - 22s c/u)",
                "Descanso de Recuperaci√≥n",
            ]
        };

        // --- VARIABLES DEL CALENDARIO ---
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();

        // --- RUTINA DEL D√çA ---
        function getTodaysRoutine() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Domingo, 1 = Lunes, etc.
            
            // Mapeo de d√≠as a rutinas
            const routineSchedule = {
                0: 'A',    // Domingo - Rutina A
                1: 'A',    // Lunes - Rutina A
                2: 'B',    // Martes - Rutina B
                3: 'CORE', // Mi√©rcoles - Rutina C (Core)
                4: 'A',    // Jueves - Rutina A
                5: 'B',    // Viernes - Rutina B
                6: 'CORE'  // S√°bado - Rutina C (Core)
            };
            
            return routineSchedule[dayOfWeek];
        }

        function getTodaysRoutineName() {
            const routineKey = getTodaysRoutine();
            const routineNames = {
                'A': 'Rutina A - Fuerza Superior',
                'B': 'Rutina B - Cardio Intenso', 
                'CORE': 'Rutina C - Full Body & Core'
            };
            return routineNames[routineKey];
        }

        function getDayName() {
            const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            return days[new Date().getDay()];
        }

        // --- ESTADO GLOBAL DE LA APP ---
        let state = {
            isRunning: false,
            isPaused: false,
            interval: null,
            timer: 0, // Segundos restantes
            currentPhase: 'SELECTION', // WARMUP, MAIN_CIRCUIT, COOLDOWN, FINISHED
            currentRoutineKey: getTodaysRoutine(), // Auto-seleccionar rutina del d√≠a
            currentRoutineExercises: [],
            currentStepIndex: -1, // √çndice dentro de la lista de la fase actual
            currentRound: 0, // Rondas para el MAIN_CIRCUIT (1 a 4)
            totalSteps: 0,
            detailsOpenedManually: false, // Controlar si los detalles fueron abiertos manualmente
            autoCloseTimeout: null, // Referencia al timeout de auto-cierre
        };

        // --- ELEMENTOS DEL DOM ---
        const $selectionScreen = document.getElementById('selection-screen');
        const $timerScreen = document.getElementById('timer-screen');
        const $phaseTitle = document.getElementById('phase-title');
        const $roundInfo = document.getElementById('round-info');
        const $exerciseName = document.getElementById('exercise-name');
        const $progressText = document.getElementById('progress-text');
        const $timerBox = document.getElementById('timer-box');
        const $pauseButton = document.getElementById('pause-button');
        const $playButton = document.getElementById('play-button');
        const $fullControls = document.getElementById('full-controls');
        const $startMessage = document.getElementById('start-message');
        const $resumeModal = document.getElementById('resume-modal');
        const $modalMessage = document.getElementById('modal-message');
        const $resumeButton = document.getElementById('resume-button');
        const $historyList = document.getElementById('history-list');
        const $userIdDisplay = document.getElementById('user-id');
        const $loadingSpinner = document.getElementById('loading-spinner');
        const $workoutButtons = document.getElementById('workout-buttons');
        const $detailsLink = document.getElementById('details-link');


        // --- AUDIO PARA SE√ëALES ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioContext = new AudioContext();

        function beep(frequency, duration, volume = 0.5) {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                gainNode.gain.value = volume;
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';

                oscillator.start();
                setTimeout(() => {
                    oscillator.stop();
                }, duration);
            } catch (e) {
                console.error("Error al reproducir audio:", e);
            }
        }
        
        // Funci√≥n para generar la estructura completa del circuito
        function createCircuitSteps(exercises, workTime, restTime) {
            const steps = [];
            for (let r = 0; r < ROUNDS; r++) {
                for (let i = 0; i < exercises.length; i++) {
                    // Paso de TRABAJO
                    steps.push({
                        name: exercises[i],
                        duration: workTime,
                        isRest: false,
                        style: 'work-color',
                        isRoundEnd: (i === exercises.length - 1)
                    });
                    
                    // Paso de DESCANSO (solo si no es el √∫ltimo ejercicio del √∫ltimo round)
                    if (!(r === ROUNDS - 1 && i === exercises.length - 1)) {
                        steps.push({
                            name: (i === exercises.length - 1) ? `DESCANSO GRANDE (Fin Ronda ${r + 1})` : `DESCANSO (Pr√≥ximo: ${exercises[i+1] || exercises[0]})`,
                            duration: restTime,
                            isRest: true,
                            style: 'rest-color',
                        });
                    }
                }
            }
            // Eliminar el √∫ltimo paso de descanso si existe, porque el Cooldown viene despu√©s.
            if (steps.length > 0 && steps[steps.length - 1].isRest) {
                 steps.pop();
            }

            return steps;
        }

        // Funci√≥n auxiliar para construir el array de ejercicios de la rutina completa
        function buildRoutine(key) {
            let mainExercises;
            switch (key) {
                case 'A':
                    mainExercises = WORKOUT_STRUCTURE.CIRCUITO_A_EXERCISES;
                    break;
                case 'B':
                    mainExercises = WORKOUT_STRUCTURE.CIRCUITO_B_EXERCISES;
                    break;
                case 'CORE':
                    mainExercises = WORKOUT_STRUCTURE.CORE_EXERCISES;
                    break;
                default:
                    return [];
            }
            
            const mainCircuitSteps = createCircuitSteps(mainExercises, key === 'CORE' ? CORE_WORK_TIME : WORK_TIME, key === 'CORE' ? CORE_REST_TIME : REST_TIME);

            return [
                ...WORKOUT_STRUCTURE.WARMUP.map(e => ({...e, phase: 'CALENTAMIENTO'})),
                ...mainCircuitSteps.map(e => ({...e, phase: 'CIRCUITO PRINCIPAL'})),
                ...WORKOUT_STRUCTURE.COOLDOWN.map(e => ({...e, phase: 'ENFRIAMIENTO'})),
            ];
        }


        window.startWorkout = function(key, savedProgress = null) {
            if (state.isRunning) return;
            
            // 1. Ocultar selecci√≥n y mostrar temporizador
            $selectionScreen.classList.add('hidden');
            $timerScreen.classList.remove('hidden');
            
            // Ocultar bot√≥n de volver al inicio
            document.getElementById('back-to-start-button').classList.add('hidden');

            state.currentRoutineKey = key;
            state.isRunning = true;
            state.isPaused = true; // Iniciar pausado para mostrar bot√≥n de PLAY
            
            // 2. Construir la rutina completa
            state.currentRoutineExercises = buildRoutine(key);
            state.totalSteps = state.currentRoutineExercises.length;
            
            if (savedProgress) {
                // REANUDAR: Usar el progreso cargado
                state.currentPhase = savedProgress.currentPhase;
                state.currentRound = savedProgress.currentRound;
                state.currentStepIndex = savedProgress.currentStepIndex;
                state.timer = savedProgress.timer;
                state.isPaused = false; // Al reanudar, continuar autom√°ticamente

                // Si el tiempo es 0, avanzamos un paso (para empezar el siguiente ejercicio/descanso)
                if (state.timer <= 0) {
                    state.currentStepIndex++;
                }

            } else {
                // NUEVA: Iniciar desde el primer paso (pausado)
                state.currentPhase = 'WARMUP';
                state.currentStepIndex = -1;
                state.currentRound = 0;
                // state.isPaused ya est√° establecido en true arriba
            }
            
            // 3. Iniciar la secuencia desde el paso actual
            nextStep(true); // El flag 'true' es para indicar que es el primer 'nextStep'
        }
        
        // --- FUNCI√ìN PARA GUARDAR EL PROGRESO (FIREBASE + JSON RESPALDO) ---
        async function saveProgress(source = 'auto') {
            if (!state.isRunning || state.currentPhase === 'FINISHED') {
                console.log(`Guardado omitido (IsRunning: ${state.isRunning}, Phase: ${state.currentPhase})`);
                return;
            }

            const progressData = {
                currentStepIndex: state.currentStepIndex,
                currentRoutineKey: state.currentRoutineKey,
                currentPhase: state.currentPhase,
                currentRound: state.currentRound,
                timer: state.timer,
                timestamp: new Date().toISOString(),
                source: source
            };

            // Si Firebase est√° disponible, usar Firebase
            if (isAuthReady) {
                try {
                    const progressDocRef = doc(db, `artifacts/${appId}/users/${userId}/workout_progress`, 'status');
                    await setDoc(progressDocRef, progressData);
                    console.log("Progreso guardado en Firestore.");
                } catch (e) {
                    console.error("Error guardando en Firestore:", e);
                    // Fallback a JSON si Firebase falla
                    saveProgressToJSON(progressData, source);
                }
            } else {
                // Usar sistema JSON local si Firebase no est√° disponible
                saveProgressToJSON(progressData, source);
            }
        }

        // --- FUNCIONES DEL SISTEMA JSON F√çSICO ---
        async function saveProgressToJSON(progressData, source = 'auto') {
            try {
                // Guardar en localStorage (respaldo inmediato)
                localStorage.setItem('workout_progress', JSON.stringify(progressData));
                updateLocalJSONStorage('progress', progressData);
                
                // Guardar en archivo f√≠sico en el servidor
                await saveToPhysicalFile('saveProgress', progressData);
                
                if (source === 'manual') {
                    document.getElementById('progress-info').textContent = '¬°Progreso guardado en archivo f√≠sico!';
                    setTimeout(() => {
                        document.getElementById('progress-info').textContent = 'Selecciona una rutina para empezar.';
                    }, 3000);
                }
                
                console.log("‚úÖ Progreso guardado en sistema JSON f√≠sico y local.");
            } catch (e) {
                console.error("‚ùå Error guardando progreso:", e);
                // Si falla el archivo f√≠sico, al menos queda en localStorage
                console.log("‚ö†Ô∏è Progreso guardado solo en localStorage como respaldo.");
            }
        }

        // Funci√≥n para comunicarse con el backend PHP
        async function saveToPhysicalFile(action, data) {
            try {
                const response = await fetch('./api/data_handler.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        action: action,
                        data: data
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ ${action} guardado en archivo f√≠sico:`, result.file || '');
                    return result;
                } else {
                    throw new Error(result.message);
                }
                
            } catch (e) {
                console.error(`‚ùå Error en ${action}:`, e);
                throw e;
            }
        }

        // Funci√≥n para cargar desde archivo f√≠sico
        async function loadFromPhysicalFile(action) {
            try {
                const response = await fetch('./api/data_handler.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        action: action
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ ${action} cargado desde archivo f√≠sico`);
                    return result.data;
                } else {
                    console.log(`‚ö†Ô∏è No se pudo cargar ${action} desde archivo f√≠sico:`, result.message);
                    return null;
                }
                
            } catch (e) {
                console.error(`‚ùå Error cargando ${action}:`, e);
                return null;
            }
        }

        function updateLocalJSONStorage(type, data) {
            try {
                let storage = JSON.parse(localStorage.getItem('workout_data') || '{}');
                
                if (!storage[type]) {
                    storage[type] = {};
                }
                
                if (type === 'progress') {
                    storage[type] = data;
                } else if (type === 'history') {
                    Object.assign(storage[type], data);
                }
                
                storage.lastUpdated = new Date().toISOString();
                storage.userId = userId;
                
                localStorage.setItem('workout_data', JSON.stringify(storage, null, 2));
                console.log(`Sistema JSON local actualizado: ${type}`);
                
            } catch (e) {
                console.error("Error actualizando sistema JSON:", e);
            }
        }
        
        // --- FUNCI√ìN PARA REGISTRAR LA RUTINA COMPLETA (FIREBASE + JSON) ---
        async function logCompletedWorkout(routineKey) {
            const todayId = new Date().toISOString().split('T')[0];
            const now = new Date().toISOString();

            const historyData = {
                routine: routineKey,
                timestamp: now,
            };

            // Si Firebase est√° disponible, usar Firebase
            if (isAuthReady) {
                try {
                    console.log("--- Guardando en Firebase ---");
                    console.log(`Ruta: artifacts/${appId}/users/${userId}/workout_history/${todayId}`);
                    console.log(JSON.stringify(historyData, null, 2));
                    
                    const historyDocRef = doc(db, `artifacts/${appId}/users/${userId}/workout_history`, todayId);
                    await setDoc(historyDocRef, historyData);
                    
                    console.log(`Rutina ${routineKey} registrada en Firebase para ${todayId}.`);
                    loadHistory();
                    
                } catch (e) {
                    console.error("Error guardando en Firebase:", e);
                    // Fallback a JSON si Firebase falla
                    logCompletedWorkoutToJSON(routineKey, historyData, todayId);
                }
            } else {
                // Usar sistema JSON local si Firebase no est√° disponible
                logCompletedWorkoutToJSON(routineKey, historyData, todayId);
            }
        }

        async function logCompletedWorkoutToJSON(routineKey, historyData, todayId) {
            console.log("--- Guardando en sistema JSON f√≠sico ---");
            console.log(JSON.stringify(historyData, null, 2));
            
            try {
                // Guardar en localStorage (respaldo inmediato)
                updateLocalJSONStorage('history', { [todayId]: historyData });
                
                // Guardar en archivo f√≠sico en el servidor
                await saveToPhysicalFile('saveWorkout', historyData);
                
                console.log(`‚úÖ Rutina ${routineKey} registrada en archivo f√≠sico para ${todayId}.`);
                
            } catch (e) {
                console.error("‚ùå Error guardando rutina en archivo f√≠sico:", e);
                console.log("‚ö†Ô∏è Rutina guardada solo en localStorage como respaldo.");
            }
            
            // Actualizar la lista de historial
            loadHistoryFromJSON();
            
            // Actualizar calendario
            renderCalendar();
        }
        
        // --- FUNCI√ìN PARA CARGAR EL PROGRESO (FIREBASE + JSON) ---
        async function loadProgress() {
            // Si Firebase est√° disponible, intentar cargar desde Firebase
            if (isAuthReady) {
                try {
                    const progressDocRef = doc(db, `artifacts/${appId}/users/${userId}/workout_progress`, 'status');
                    const docSnap = await getDoc(progressDocRef);

                    if (docSnap.exists() && docSnap.data().currentStepIndex > -1) {
                        const savedProgress = docSnap.data();
                        showResumeModal(savedProgress, 'Firebase');
                        return;
                    } else {
                        console.log("No se encontr√≥ progreso en Firebase.");
                    }
                } catch (e) {
                    console.error("Error cargando progreso de Firebase:", e);
                }
            }
            
            // Fallback o modo JSON: cargar desde localStorage/JSON
            loadProgressFromJSON();
        }

        async function loadProgressFromJSON() {
            try {
                // Intentar cargar desde archivo f√≠sico primero
                const physicalData = await loadFromPhysicalFile('loadProgress');
                if (physicalData && physicalData.currentStepIndex > -1) {
                    showResumeModal(physicalData, 'Archivo F√≠sico');
                    return;
                }

                // Fallback: cargar desde localStorage
                const savedData = localStorage.getItem('workout_progress');
                if (savedData) {
                    const savedProgress = JSON.parse(savedData);
                    
                    if (savedProgress.currentStepIndex > -1) {
                        showResumeModal(savedProgress, 'JSON Local (Respaldo)');
                        return;
                    }
                }

                // √öltimo fallback: desde workout_data
                const workoutData = JSON.parse(localStorage.getItem('workout_data') || '{}');
                if (workoutData.progress && workoutData.progress.currentStepIndex > -1) {
                    showResumeModal(workoutData.progress, 'Sistema JSON (Respaldo)');
                    return;
                }

                console.log("No se encontr√≥ progreso guardado.");
                
            } catch (e) {
                console.error("Error cargando progreso:", e);
            }
        }

        function showResumeModal(savedProgress, source) {
            $modalMessage.textContent = `Se encontr√≥ progreso (${source}) para el circuito ${savedProgress.currentRoutineKey} en la fase "${savedProgress.currentPhase}". ¬øDeseas reanudar?`;
            
            $resumeButton.onclick = () => {
                $resumeModal.classList.add('hidden');
                startWorkout(savedProgress.currentRoutineKey, savedProgress);
            };
            
            $resumeModal.classList.remove('hidden');
        }

        // --- FUNCI√ìN PARA CARGAR EL HISTORIAL (FIREBASE + JSON) ---
        async function loadHistory() {
            $historyList.innerHTML = '<p class="text-gray-400" id="loading-history">Cargando historial...</p>';

            // Si Firebase est√° disponible, intentar cargar desde Firebase
            if (isAuthReady) {
                try {
                    const historyColRef = collection(db, `artifacts/${appId}/users/${userId}/workout_history`);
                    const querySnapshot = await getDocs(historyColRef);
                    
                    let historyItems = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        historyItems.push({ 
                            date: doc.id, 
                            routine: data.routine,
                            timestamp: data.timestamp
                        });
                    });
                    
                    if (historyItems.length > 0) {
                        displayHistory(historyItems, 'Firebase');
                        return;
                    } else {
                        console.log("No se encontr√≥ historial en Firebase.");
                    }
                } catch (e) {
                    console.error("Error cargando historial de Firebase:", e);
                }
            }
            
            // Fallback o modo JSON: cargar desde sistema JSON local
            loadHistoryFromJSON();
        }

        async function loadHistoryFromJSON() {
            try {
                // Intentar cargar desde archivo f√≠sico primero
                const physicalData = await loadFromPhysicalFile('loadHistory');
                if (physicalData && Object.keys(physicalData).length > 0) {
                    // Almacenar datos f√≠sicos globalmente para el calendario
                    window.physicalHistoryData = physicalData;
                    
                    let historyItems = [];
                    
                    Object.entries(physicalData).forEach(([date, data]) => {
                        historyItems.push({ 
                            date: date, 
                            routine: data.routine,
                            timestamp: data.timestamp
                        });
                    });
                    
                    displayHistory(historyItems, 'Archivo F√≠sico');
                    renderCalendar(); // Actualizar calendario cuando se cargan los datos
                    return;
                }

                // Fallback: cargar desde localStorage
                const workoutData = JSON.parse(localStorage.getItem('workout_data') || '{}');
                
                if (workoutData.history && Object.keys(workoutData.history).length > 0) {
                    let historyItems = [];
                    
                    Object.entries(workoutData.history).forEach(([date, data]) => {
                        historyItems.push({ 
                            date: date, 
                            routine: data.routine,
                            timestamp: data.timestamp
                        });
                    });
                    
                    displayHistory(historyItems, 'JSON Local (Respaldo)');
                } else {
                    $historyList.innerHTML = '<p class="text-gray-400">¬°A√∫n no has completado ninguna rutina! ¬°Empieza hoy!</p>';
                }
                
            } catch (e) {
                console.error("Error cargando historial:", e);
                $historyList.innerHTML = '<p class="text-yellow-400">Error cargando historial.</p>';
            }
        }

        function displayHistory(historyItems, source) {
            // Ordenar por fecha (m√°s reciente primero)
            historyItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            $historyList.innerHTML = '';
            
            if (historyItems.length === 0) {
                $historyList.innerHTML = '<p class="text-gray-400">¬°A√∫n no has completado ninguna rutina! ¬°Empieza hoy!</p>';
            } else {
                // Agregar indicador de fuente
                $historyList.innerHTML = `<p class="text-xs text-gray-500 mb-2">Fuente: ${source}</p>`;
                
                historyItems.forEach(item => {
                    const dateObj = new Date(item.timestamp);
                    const formattedDate = dateObj.toLocaleDateString('es-ES', { 
                        year: 'numeric', month: 'long', day: 'numeric' 
                    });
                    
                    const element = `
                        <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg shadow-md">
                            <span class="text-gray-300 font-medium">${formattedDate}</span>
                            <span class="px-3 py-1 text-sm font-bold rounded-full ${item.routine === 'CORE' ? 'bg-blue-400 text-blue-900' : 'bg-primary text-gray-900'}">
                                ${item.routine}
                            </span>
                        </div>
                    `;
                    $historyList.innerHTML += element;
                });
            }
        }
        
        window.continueWithoutResume = function() {
            $resumeModal.classList.add('hidden');
        }

        // --- FUNCI√ìN PARA VOLVER AL EJERCICIO ANTERIOR ---
        window.goBack = function() {
            if (!state.isRunning || state.currentStepIndex <= 0) return;

            clearInterval(state.interval);
            state.isPaused = false;
            
            state.currentStepIndex -= 2;

            if (state.currentStepIndex < 0) {
                state.currentStepIndex = 0; 
            }
            
            nextStep(true);
        }

        window.nextStep = function(isNavigation = false) {
            clearInterval(state.interval);

            if (!isNavigation) {
                state.currentStepIndex++;
            }
            
            // Resetear el estado de detalles manuales al cambiar de ejercicio
            state.detailsOpenedManually = false;
            if (state.autoCloseTimeout) {
                clearTimeout(state.autoCloseTimeout);
                state.autoCloseTimeout = null;
            }
            
            // Despu√©s del primer paso, el entrenamiento debe continuar autom√°ticamente
            // Solo pausar en el primer paso (calentamiento inicial)
            if (state.currentStepIndex === 0) {
                // Primer paso: mostrar bot√≥n INICIAR
                if (state.isPaused) {
                    $pauseButton.textContent = 'PAUSAR';
                    $timerBox.classList.add('text-gray-500');
                }
            } else {
                // Pasos subsiguientes: continuar autom√°ticamente
                state.isPaused = false;
                $pauseButton.textContent = 'PAUSAR';
                $timerBox.classList.remove('text-gray-500');
            }
            
            // 1. COMPROBAR FIN DE ENTRENAMIENTO
            if (state.currentStepIndex >= state.totalSteps) {
                // Registrar el d√≠a como completado antes de finalizar
                logCompletedWorkout(state.currentRoutineKey);
                finishWorkout();
                clearSavedProgress();
                return;
            }

            // 2. OBTENER PASO ACTUAL
            const currentStep = state.currentRoutineExercises[state.currentStepIndex];

            // Siempre resetear el timer al tiempo completo del ejercicio
            // ya sea por navegaci√≥n manual o por tiempo terminado
            state.timer = currentStep.duration;

            // 3. ACTUALIZAR FASE y RONDAS
            state.currentPhase = currentStep.phase;

            if (currentStep.phase === 'CIRCUITO PRINCIPAL') {
                const exercisesPerRound = WORKOUT_STRUCTURE.CIRCUITO_A_EXERCISES.length;
                let workStepsCompleted = 0;
                
                for(let i = WORKOUT_STRUCTURE.WARMUP.length; i <= state.currentStepIndex; i++) {
                     if (state.currentRoutineExercises[i] && state.currentRoutineExercises[i].phase === 'CIRCUITO PRINCIPAL' && !state.currentRoutineExercises[i].isRest) {
                        workStepsCompleted++;
                    }
                }
                
                state.currentRound = Math.ceil(workStepsCompleted / exercisesPerRound);
                if (state.currentRound < 1) state.currentRound = 1;

            } else if (currentStep.phase === 'WARMUP' || currentStep.phase === 'ENFRIAMIENTO') {
                state.currentRound = 0;
            }


            // 4. ACTUALIZAR PANTALLA
            updateDisplay(currentStep);
            
            // 5. GUARDAR PROGRESO (Autom√°tico)
            saveProgress('auto');
            
            // 6. INICIAR TEMPORIZADOR (solo si no est√° pausado)
            if (!state.isPaused) {
                // Limpiar cualquier intervalo anterior antes de crear uno nuevo
                clearInterval(state.interval);
                
                if (!currentStep.isRest) {
                    beep(880, 200, 0.7);
                } else {
                    beep(440, 100, 0.5);
                }
                state.interval = setInterval(tick, 1000);
            }
        }
        
        window.saveProgress = saveProgress;
        
        async function clearSavedProgress() {
             // Limpiar progreso de archivo f√≠sico primero
             try {
                 await saveToPhysicalFile('clearProgress', {});
                 console.log("‚úÖ Progreso eliminado del archivo f√≠sico.");
             } catch (e) {
                 console.error("‚ùå Error limpiando progreso f√≠sico:", e);
             }

             // Limpiar progreso del sistema JSON local
             try {
                 localStorage.removeItem('workout_progress');
                 
                 // Tambi√©n limpiar el progreso del almacenamiento JSON completo
                 let storage = JSON.parse(localStorage.getItem('workout_data') || '{}');
                 if (storage.progress) {
                     delete storage.progress;
                     localStorage.setItem('workout_data', JSON.stringify(storage, null, 2));
                 }
                 
                 console.log("‚úÖ Progreso eliminado del sistema JSON local.");
             } catch (e) {
                 console.error("‚ùå Error limpiando progreso JSON:", e);
             }

             // Si Firebase est√° disponible, tambi√©n limpiar all√≠
             if (isAuthReady) {
                 try {
                    const progressDocRef = doc(db, `artifacts/${appId}/users/${userId}/workout_progress`, 'status');
                    await setDoc(progressDocRef, { currentStepIndex: -1, currentRoutineKey: '', currentPhase: 'FINISHED' }, { merge: true });
                    console.log("‚úÖ Progreso eliminado de Firebase.");
                 } catch (e) {
                    console.error("‚ùå Error limpiando progreso Firebase:", e);
                 }
             }
        }

        function tick() {
            if (state.isPaused) return;

            // Solo decrementar si el timer es mayor a 0
            if (state.timer > 0) {
                state.timer--;
            }
            
            // 1. MANEJO DE SONIDOS DE ALERTA
            if (state.timer > 0 && state.timer <= 5) {
                beep(600, 100, 0.8);
            } else if (state.timer === 0) {
                beep(1200, 400, 1.0);
            }

            // 2. ACTUALIZACI√ìN DE PANTALLA
            const currentStep = state.currentRoutineExercises[state.currentStepIndex];
            updateDisplay(currentStep);

            // 3. CAMBIO DE PASO
            if (state.timer <= 0) {
                // Detener el interval inmediatamente para evitar valores negativos
                clearInterval(state.interval);
                nextStep(); // No pasar 'true' aqu√≠, nextStep() ya maneja el incremento
            }
        }

        function updateDisplay(step) {
            // Prevenir valores negativos del timer
            if (state.timer < 0) {
                state.timer = 0;
            }
            
            const minutes = Math.floor(state.timer / 60).toString().padStart(2, '0');
            const seconds = (state.timer % 60).toString().padStart(2, '0');
            $timerBox.textContent = `${minutes}:${seconds}`;

            $phaseTitle.textContent = step.phase;
            $phaseTitle.className = `text-xl font-medium uppercase tracking-widest ${step.style || 'ready-color'}`;
            
            let exerciseName = step.name;
            
            // Mostrar pr√≥ximo ejercicio en los √∫ltimos 5 segundos
            if (state.timer <= 5 && state.timer > 0 && !step.isRest) {
                const nextStepIndex = state.currentStepIndex + 1;
                if (nextStepIndex < state.currentRoutineExercises.length) {
                    const nextStep = state.currentRoutineExercises[nextStepIndex];
                    
                    // No mostrar "PR√ìXIMO:" si el siguiente es "¬°Entrenamiento Terminado!"
                    if (nextStep && nextStep.name !== "¬°Entrenamiento Terminado!") {
                        if (!nextStep.isRest) {
                            exerciseName = `PR√ìXIMO: ${nextStep.name}`;
                            // Mostrar detalles del pr√≥ximo ejercicio autom√°ticamente
                            updateExerciseDetails(nextStep.name);
                            showExercisePreparation(nextStep.name, state.timer);
                        } else if (nextStep.isRest) {
                            // Si el pr√≥ximo es descanso, buscar el ejercicio despu√©s del descanso
                            const nextExerciseIndex = nextStepIndex + 1;
                            if (nextExerciseIndex < state.currentRoutineExercises.length) {
                                const nextExercise = state.currentRoutineExercises[nextExerciseIndex];
                                if (nextExercise && !nextExercise.isRest && nextExercise.name !== "¬°Entrenamiento Terminado!") {
                                    exerciseName = `PR√ìXIMO: ${nextExercise.name}`;
                                    updateExerciseDetails(nextExercise.name);
                                    showExercisePreparation(nextExercise.name, state.timer);
                                }
                            }
                        }
                    }
                }
            }
            
            $exerciseName.textContent = exerciseName;
            $timerBox.className = `timer-display mb-8 ${step.style || 'ready-color'}`;

            // Actualizar indicador de progreso
            updateProgressIndicator();

            // Controlar visibilidad de botones al inicio
            if (state.isPaused && state.currentStepIndex === 0) {
                $playButton.classList.remove('hidden');
                $fullControls.classList.add('hidden');
                $startMessage.classList.remove('hidden');
                $timerBox.classList.add('text-gray-500');
            } else if (!state.isPaused) {
                $playButton.classList.add('hidden');
                $fullControls.classList.remove('hidden');
                $startMessage.classList.add('hidden');
                $timerBox.classList.remove('text-gray-500');
            }

            // --- Actualizar detalles del ejercicio ---
            if (!step.isRest) {
                // Para ejercicios normales, usar el nombre original del step, no el texto "PR√ìXIMO:"
                const originalExerciseName = step.name;
                
                // Solo mostrar detalles autom√°ticamente si el ejercicio dice "PR√ìXIMO"
                if (exerciseName.includes('PR√ìXIMO')) {
                    // Ya se actualizaron los detalles en la secci√≥n anterior cuando se detect√≥ "PR√ìXIMO:"
                    // No necesitamos hacer nada m√°s aqu√≠
                } else {
                    // Para ejercicios normales, actualizar con el nombre original
                    updateExerciseDetails(originalExerciseName);
                    
                    // Solo asegurar que el bot√≥n est√© disponible
                    // NO forzar ocultar si fueron abiertos manualmente
                    if (!state.detailsOpenedManually) {
                        document.getElementById('exercise-details').classList.add('hidden');
                        document.getElementById('show-details-button').classList.remove('hidden');
                    }
                }
            } else {
                // Durante descansos, verificar si menciona el pr√≥ximo ejercicio
                if (exerciseName.includes('Pr√≥ximo:')) {
                    // Extraer el nombre del pr√≥ximo ejercicio
                    const nextExerciseMatch = exerciseName.match(/Pr√≥ximo:\s*(.+)/);
                    if (nextExerciseMatch) {
                        const nextExerciseName = nextExerciseMatch[1].trim();
                        // Mostrar detalles del pr√≥ximo ejercicio durante el descanso
                        updateExerciseDetails(nextExerciseName);
                        showExercisePreparation(nextExerciseName, state.timer);
                    }
                } else {
                    // Descansos normales sin pr√≥ximo ejercicio
                    state.detailsOpenedManually = false; // Reset porque es descanso
                    document.getElementById('exercise-details').classList.add('hidden');
                    document.getElementById('show-details-button').classList.add('hidden');
                    document.getElementById('preparation-indicator').classList.add('hidden');
                }
            }

            // --- L√≥gica del bot√≥n de B√∫squeda de Video ---
            if (step.phase === 'CIRCUITO PRINCIPAL' && !step.isRest) {
                const searchQuery = encodeURIComponent(`${exerciseName} t√©cnica video`);
                $detailsLink.href = `https://www.google.com/search?tbm=vid&q=${searchQuery}`;
                $detailsLink.classList.remove('hidden');
            } else {
                $detailsLink.classList.add('hidden');
            }

            let progressText = `Paso ${state.currentStepIndex + 1} de ${state.totalSteps}.`;
            if (state.currentPhase === 'CIRCUITO PRINCIPAL' && state.currentRound > 0) {
                const totalExercises = WORKOUT_STRUCTURE.CIRCUITO_A_EXERCISES.length;
                
                const mainCircuitStepsStart = WORKOUT_STRUCTURE.WARMUP.length;
                let stepInCircuit = state.currentStepIndex - mainCircuitStepsStart;
                
                let exerciseNumber;
                
                if (step.isRest) {
                    stepInCircuit = state.currentStepIndex - mainCircuitStepsStart - 1;
                    exerciseNumber = ((Math.floor(stepInCircuit / 2)) % totalExercises) + 1;
                } else {
                    exerciseNumber = ((Math.floor(stepInCircuit / 2)) % totalExercises) + 1;
                }
                
                progressText = `Ronda ${state.currentRound} de ${ROUNDS} | Ejercicio ${exerciseNumber} de ${totalExercises}`;

            } else if (state.currentPhase === 'WARMUP' || state.currentPhase === 'ENFRIAMIENTO') {
                // Mapear correctamente las fases a las propiedades de WORKOUT_STRUCTURE
                const phaseMapping = {
                    'WARMUP': 'WARMUP',
                    'ENFRIAMIENTO': 'COOLDOWN'
                };
                
                const structureKey = phaseMapping[state.currentPhase];
                if (structureKey && WORKOUT_STRUCTURE[structureKey]) {
                    const totalInPhase = WORKOUT_STRUCTURE[structureKey].length;
                    let phaseStep;

                    if (state.currentPhase === 'WARMUP') {
                        phaseStep = state.currentStepIndex + 1;
                    } else {
                        const cooldownStart = state.totalSteps - WORKOUT_STRUCTURE.COOLDOWN.length;
                        phaseStep = state.currentStepIndex - cooldownStart + 1;
                    }
                    progressText = `Paso ${phaseStep} de ${totalInPhase}`;
                } else {
                    progressText = `Paso ${state.currentStepIndex + 1} de ${state.totalSteps}`;
                }
            }
            
            $roundInfo.textContent = progressText;

            $pauseButton.textContent = state.isPaused ? 'REANUDAR' : 'PAUSAR';
        }

        window.togglePause = function() {
            state.isPaused = !state.isPaused;
            if (state.isPaused) {
                clearInterval(state.interval);
                $timerBox.classList.add('text-gray-500');
                saveProgress('pause'); 
            } else {
                state.interval = setInterval(tick, 1000);
                $timerBox.classList.remove('text-gray-500');
            }
            $pauseButton.textContent = state.isPaused ? 'REANUDAR' : 'PAUSAR';
        }

        function finishWorkout() {
            clearInterval(state.interval);
            state.isRunning = false;
            state.currentPhase = 'FINISHED';

            $phaseTitle.textContent = '¬°RUTINA COMPLETA!';
            $exerciseName.textContent = '¬°FELICITACIONES! Vuelve pronto.';
            $timerBox.textContent = '00:00';
            $timerBox.className = 'timer-display mb-8 finished-color';
            $roundInfo.textContent = `Rutina ${state.currentRoutineKey} terminada.`;
            $progressText.textContent = '¬°Entrenamiento completado! üéâ';

            // Ocultar controles del entrenamiento y mostrar bot√≥n de regreso
            $pauseButton.classList.add('hidden');
            document.getElementById('full-controls').classList.add('hidden');
            
            // Mostrar bot√≥n para volver al inicio
            showBackToStartButton();
            
            // Guardar el entrenamiento completado
            logCompletedWorkout(state.currentRoutineKey);
        }
        
        window.resetWorkout = function() {
            clearInterval(state.interval);
            clearSavedProgress();
            state = {
                isRunning: false,
                isPaused: false,
                interval: null,
                timer: 0, 
                currentPhase: 'SELECTION', 
                currentRoutineKey: '', 
                currentRoutineExercises: [],
                currentStepIndex: -1, 
                currentRound: 0, 
                totalSteps: 0,
            };
            
            $selectionScreen.classList.remove('hidden');
            $timerScreen.classList.add('hidden'); 
            $pauseButton.classList.remove('hidden');
            $pauseButton.textContent = 'PAUSAR';
            
            // Ocultar bot√≥n de volver al inicio
            document.getElementById('back-to-start-button').classList.add('hidden');
            
            document.getElementById('progress-info').textContent = 'Selecciona una rutina para empezar.';
        }

        // --- FUNCIONES PARA VOLVER AL INICIO ---
        function showBackToStartButton() {
            const backButton = document.getElementById('back-to-start-button');
            if (backButton) {
                backButton.classList.remove('hidden');
            }
        }

        window.backToStart = function() {
            // Limpiar progreso guardado
            clearSavedProgress();
            
            // Resetear el estado global
            state = {
                isRunning: false,
                isPaused: false,
                interval: null,
                timer: 0, 
                currentPhase: 'SELECTION', 
                currentRoutineKey: getTodaysRoutine(), // Volver a la rutina del d√≠a
                currentRoutineExercises: [],
                currentStepIndex: -1, 
                currentRound: 0, 
                totalSteps: 0,
                detailsOpenedManually: false,
                autoCloseTimeout: null,
            };
            
            // Ocultar pantalla de entrenamiento y mostrar selecci√≥n
            $timerScreen.classList.add('hidden');
            $selectionScreen.classList.remove('hidden');
            
            // Ocultar bot√≥n de volver al inicio
            document.getElementById('back-to-start-button').classList.add('hidden');
            
            // Mostrar controles de entrenamiento normales
            $pauseButton.classList.remove('hidden');
            $pauseButton.textContent = 'PAUSAR';
            
            // Actualizar informaci√≥n del d√≠a
            updateTodaysRoutineDisplay();
            document.getElementById('progress-info').textContent = 'Tu centro de entrenamiento completo';
            
            // Recargar historial y calendario (para reflejar el nuevo entrenamiento completado)
            loadHistory();
            renderCalendar();
            
            console.log('üè† Regresando al inicio - Rutina completada guardada');
        }

        // --- FUNCIONES PARA RUTINA DEL D√çA ---
        function startTodaysWorkout() {
            const todaysRoutine = getTodaysRoutine();
            startWorkout(todaysRoutine);
        }

        function showRoutineSelector() {
            // Crear un modal simple para elegir rutina
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-xl max-w-sm w-full mx-4">
                    <h3 class="text-xl font-bold text-white mb-4 text-center">Elegir Rutina</h3>
                    <div class="space-y-3">
                        <button onclick="selectRoutine('A')" class="w-full py-3 rounded-lg bg-orange-500 hover:bg-orange-600 transition-colors text-white font-semibold">
                            Rutina A - Fuerza Superior
                        </button>
                        <button onclick="selectRoutine('B')" class="w-full py-3 rounded-lg bg-orange-500 hover:bg-orange-600 transition-colors text-white font-semibold">
                            Rutina B - Cardio Intenso
                        </button>
                        <button onclick="selectRoutine('CORE')" class="w-full py-3 rounded-lg bg-blue-500 hover:bg-blue-600 transition-colors text-white font-semibold">
                            Rutina C - Full Body & Core
                        </button>
                        <button onclick="closeRoutineSelector()" class="w-full py-2 rounded-lg bg-gray-600 hover:bg-gray-500 transition-colors text-gray-300">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        function selectRoutine(routineKey) {
            state.currentRoutineKey = routineKey;
            updateTodaysRoutineDisplay();
            closeRoutineSelector();
            startWorkout(routineKey);
        }

        function closeRoutineSelector() {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
        }

        function updateTodaysRoutineDisplay() {
            const todayElement = document.getElementById('today-info');
            const routineElement = document.getElementById('todays-routine');
            
            if (todayElement) {
                todayElement.textContent = `üìÖ ${getDayName()}`;
            }
            
            if (routineElement) {
                routineElement.textContent = getTodaysRoutineName();
            }
        }

        // Funci√≥n para iniciar el cron√≥metro (bot√≥n PLAY)
        function startTimer() {
            if (!state.isRunning) return;
            
            state.isPaused = false;
            $playButton.classList.add('hidden');
            $fullControls.classList.remove('hidden');
            $startMessage.classList.add('hidden');
            $pauseButton.textContent = 'PAUSAR';
            $timerBox.classList.remove('text-gray-500');
            
            // Iniciar el cron√≥metro
            const currentStep = state.currentRoutineExercises[state.currentStepIndex];
            if (currentStep) {
                if (!currentStep.isRest) {
                    beep(880, 200, 0.7);
                } else {
                    beep(440, 100, 0.5);
                }
                state.interval = setInterval(tick, 1000);
            }
        }

        // --- FUNCIONES DEL CALENDARIO ---
        function renderCalendar() {
            const calendarDays = document.getElementById('calendar-days');
            const monthYearDisplay = document.getElementById('calendar-month-year');
            
            if (!calendarDays || !monthYearDisplay) return;

            // Nombres de los meses
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];

            // Actualizar t√≠tulo del mes
            monthYearDisplay.textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;

            // Obtener informaci√≥n del mes
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const startDate = firstDay.getDay(); // D√≠a de la semana del primer d√≠a
            const daysInMonth = lastDay.getDate();

            // Limpiar calendario
            calendarDays.innerHTML = '';

            // Agregar d√≠as vac√≠os al inicio
            for (let i = 0; i < startDate; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'h-8';
                calendarDays.appendChild(emptyDay);
            }

            // Agregar d√≠as del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                const currentDate = new Date(currentCalendarYear, currentCalendarMonth, day);
                const dateString = formatDateForComparison(currentDate);
                const today = new Date();
                const todayString = formatDateForComparison(today);

                // Clases base
                dayElement.className = 'h-8 w-8 rounded text-xs flex items-center justify-center font-medium transition-colors cursor-pointer';
                dayElement.textContent = day;

                // Determinar el estado del d√≠a
                if (dateString === todayString) {
                    // Hoy
                    dayElement.className += ' bg-blue-500 text-white';
                } else if (isWorkoutCompleted(dateString)) {
                    // D√≠a completado
                    dayElement.className += ' bg-green-500 text-white hover:bg-green-600';
                } else if (currentDate < today) {
                    // D√≠a pasado sin completar
                    dayElement.className += ' bg-red-500 text-white hover:bg-red-600';
                } else {
                    // D√≠a futuro
                    dayElement.className += ' bg-gray-600 text-gray-300 hover:bg-gray-500';
                }

                // Agregar evento click para mostrar detalles
                dayElement.addEventListener('click', () => showDayDetails(currentDate, dateString));
                
                calendarDays.appendChild(dayElement);
            }

            // Actualizar estad√≠sticas
            updateCalendarStats();
        }

        function changeCalendarMonth(direction) {
            currentCalendarMonth += direction;
            
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            
            renderCalendar();
        }

        function formatDateForComparison(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function isWorkoutCompleted(dateString) {
            // Verificar en localStorage primero
            const workoutData = JSON.parse(localStorage.getItem('workout_data') || '{}');
            if (workoutData.history && workoutData.history[dateString]) {
                return true;
            }

            // Verificar en datos f√≠sicos cargados (si est√°n disponibles)
            if (window.physicalHistoryData && window.physicalHistoryData[dateString]) {
                return true;
            }

            return false;
        }

        function showDayDetails(date, dateString) {
            const dayName = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'][date.getDay()];
            const formattedDate = date.toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            const isCompleted = isWorkoutCompleted(dateString);
            const today = new Date();
            const todayString = formatDateForComparison(today);

            let message = `üìÖ ${dayName}, ${formattedDate}\n\n`;
            
            if (dateString === todayString) {
                message += 'üéØ ¬°HOY! ' + getTodaysRoutineName();
            } else if (isCompleted) {
                const workoutData = JSON.parse(localStorage.getItem('workout_data') || '{}');
                const dayData = workoutData.history[dateString];
                message += `‚úÖ Completado: Rutina ${dayData.routine}`;
            } else if (date < today) {
                message += '‚ùå No completado';
            } else {
                // Determinar qu√© rutina toca ese d√≠a
                const routineForDay = getRutineForDate(date);
                message += `üìã Programado: ${routineForDay}`;
            }

            alert(message);
        }

        function getRutineForDate(date) {
            const dayOfWeek = date.getDay();
            const routineSchedule = {
                0: 'Rutina A - Fuerza Superior',    // Domingo
                1: 'Rutina A - Fuerza Superior',    // Lunes
                2: 'Rutina B - Cardio Intenso',     // Martes
                3: 'Rutina C - Full Body & Core',   // Mi√©rcoles
                4: 'Rutina A - Fuerza Superior',    // Jueves
                5: 'Rutina B - Cardio Intenso',     // Viernes
                6: 'Rutina C - Full Body & Core'    // S√°bado
            };
            return routineSchedule[dayOfWeek];
        }

        function updateCalendarStats() {
            const today = new Date();
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            
            let completed = 0;
            let missed = 0;
            let currentStreak = 0;
            let totalPastDays = 0;

            // Recorrer todos los d√≠as del mes hasta hoy
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDate = new Date(currentCalendarYear, currentCalendarMonth, day);
                const dateString = formatDateForComparison(currentDate);
                
                // Solo contar d√≠as pasados (no incluir hoy ni d√≠as futuros)
                if (currentDate < today) {
                    totalPastDays++;
                    
                    if (isWorkoutCompleted(dateString)) {
                        completed++;
                    } else {
                        missed++;
                    }
                }
            }

            // Calcular racha actual (d√≠as consecutivos completados hacia atr√°s desde ayer)
            let checkDate = new Date(today);
            checkDate.setDate(checkDate.getDate() - 1); // Empezar desde ayer
            
            while (checkDate >= firstDay && checkDate.getMonth() === currentCalendarMonth) {
                const dateString = formatDateForComparison(checkDate);
                if (isWorkoutCompleted(dateString)) {
                    currentStreak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }

            // Calcular porcentaje
            const percentage = totalPastDays > 0 ? Math.round((completed / totalPastDays) * 100) : 0;

            // Actualizar elementos del DOM
            const completedElement = document.getElementById('completed-count');
            const missedElement = document.getElementById('missed-count');
            const streakElement = document.getElementById('streak-count');
            const percentageElement = document.getElementById('completion-percentage');

            if (completedElement) completedElement.textContent = completed;
            if (missedElement) missedElement.textContent = missed;
            if (streakElement) streakElement.textContent = currentStreak + ' d√≠as';
            if (percentageElement) percentageElement.textContent = percentage + '%';
        }

        // --- FUNCIONES DEL PERFIL DE USUARIO ---
        function loadUserProfile() {
            const profile = JSON.parse(localStorage.getItem('user_profile') || '{}');
            
            if (Object.keys(profile).length > 0) {
                // Mostrar datos en el display
                document.getElementById('display-height').textContent = profile.height ? profile.height + ' cm' : '- cm';
                document.getElementById('display-weight').textContent = profile.weight ? profile.weight + ' kg' : '- kg';
                document.getElementById('display-age').textContent = profile.age ? profile.age + ' a√±os' : '- a√±os';
                document.getElementById('display-activity').textContent = getActivityLevelText(profile.activity) || '-';

                // Calcular y mostrar IMC
                if (profile.height && profile.weight) {
                    const bmi = calculateBMI(profile.height, profile.weight);
                    const category = getBMICategory(bmi);
                    document.getElementById('display-bmi').textContent = bmi.toFixed(1);
                    document.getElementById('display-bmi-category').textContent = `(${category})`;
                }

                // Cargar datos en el formulario
                if (document.getElementById('input-height')) document.getElementById('input-height').value = profile.height || '';
                if (document.getElementById('input-weight')) document.getElementById('input-weight').value = profile.weight || '';
                if (document.getElementById('input-age')) document.getElementById('input-age').value = profile.age || '';
                if (document.getElementById('input-gender')) document.getElementById('input-gender').value = profile.gender || '';
                if (document.getElementById('input-activity')) document.getElementById('input-activity').value = profile.activity || '';
            }

            // Cargar historial de peso
            loadWeightHistory();
        }

        function toggleProfileEditor() {
            const editor = document.getElementById('profile-editor');
            const isHidden = editor.classList.contains('hidden');
            
            if (isHidden) {
                editor.classList.remove('hidden');
                loadUserProfile(); // Cargar datos actuales
            } else {
                editor.classList.add('hidden');
            }
        }

        function saveUserProfile() {
            const profile = {
                height: parseFloat(document.getElementById('input-height').value) || null,
                weight: parseFloat(document.getElementById('input-weight').value) || null,
                age: parseInt(document.getElementById('input-age').value) || null,
                gender: document.getElementById('input-gender').value || null,
                activity: document.getElementById('input-activity').value || null,
                lastUpdated: new Date().toISOString()
            };

            // Validaciones b√°sicas
            if (profile.height && (profile.height < 100 || profile.height > 250)) {
                alert('‚ùå La altura debe estar entre 100 y 250 cm');
                return;
            }

            if (profile.weight && (profile.weight < 30 || profile.weight > 300)) {
                alert('‚ùå El peso debe estar entre 30 y 300 kg');
                return;
            }

            if (profile.age && (profile.age < 13 || profile.age > 100)) {
                alert('‚ùå La edad debe estar entre 13 y 100 a√±os');
                return;
            }

            // Guardar perfil
            localStorage.setItem('user_profile', JSON.stringify(profile));

            // Si cambi√≥ el peso, agregarlo al historial
            const currentProfile = JSON.parse(localStorage.getItem('user_profile') || '{}');
            if (profile.weight && profile.weight !== currentProfile.weight) {
                addWeightEntry(profile.weight, false); // No mostrar alerta de √©xito
            }

            // Actualizar display
            loadUserProfile();
            
            // Ocultar editor
            document.getElementById('profile-editor').classList.add('hidden');
            
            alert('‚úÖ Perfil guardado exitosamente');
        }

        function calculateBMI(height, weight) {
            const heightInMeters = height / 100;
            return weight / (heightInMeters * heightInMeters);
        }

        function getBMICategory(bmi) {
            if (bmi < 18.5) return 'Bajo peso';
            if (bmi < 25) return 'Normal';
            if (bmi < 30) return 'Sobrepeso';
            return 'Obesidad';
        }

        function getActivityLevelText(level) {
            const levels = {
                'sedentary': 'Sedentario',
                'light': 'Ligero',
                'moderate': 'Moderado',
                'active': 'Activo',
                'very-active': 'Muy activo'
            };
            return levels[level] || '';
        }

        function addWeightEntry(weight = null, showAlert = true) {
            const weightInput = document.getElementById('new-weight');
            const newWeight = weight || parseFloat(weightInput.value);
            
            if (!newWeight || newWeight < 30 || newWeight > 300) {
                alert('‚ùå Ingresa un peso v√°lido entre 30 y 300 kg');
                return;
            }

            // Obtener historial actual
            const weightHistory = JSON.parse(localStorage.getItem('weight_history') || '[]');
            
            // Agregar nueva entrada
            const entry = {
                weight: newWeight,
                date: new Date().toISOString(),
                dateString: formatDateForComparison(new Date())
            };

            weightHistory.unshift(entry); // Agregar al inicio (m√°s reciente)

            // Mantener solo los √∫ltimos 50 registros
            if (weightHistory.length > 50) {
                weightHistory.splice(50);
            }

            // Guardar
            localStorage.setItem('weight_history', JSON.stringify(weightHistory));

            // Actualizar perfil con el peso m√°s reciente
            const profile = JSON.parse(localStorage.getItem('user_profile') || '{}');
            profile.weight = newWeight;
            profile.lastWeightUpdate = new Date().toISOString();
            localStorage.setItem('user_profile', JSON.stringify(profile));

            // Limpiar input y recargar
            if (weightInput) weightInput.value = '';
            loadUserProfile();

            if (showAlert) {
                alert('‚úÖ Peso registrado exitosamente');
            }
        }

        function loadWeightHistory() {
            const weightHistory = JSON.parse(localStorage.getItem('weight_history') || '[]');
            const container = document.getElementById('weight-history');
            
            if (!container) return;

            if (weightHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-xs">No hay registros de peso a√∫n</p>';
                return;
            }

            let html = '';
            weightHistory.slice(0, 10).forEach((entry, index) => { // Mostrar solo los √∫ltimos 10
                const date = new Date(entry.date);
                const formattedDate = date.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                const weightChange = index < weightHistory.length - 1 ? 
                    entry.weight - weightHistory[index + 1].weight : 0;
                
                let changeIcon = '';
                let changeClass = '';
                if (weightChange > 0) {
                    changeIcon = 'üìà';
                    changeClass = 'text-red-400';
                } else if (weightChange < 0) {
                    changeIcon = 'üìâ';
                    changeClass = 'text-green-400';
                } else {
                    changeIcon = '‚ûñ';
                    changeClass = 'text-gray-400';
                }

                html += `
                    <div class="flex justify-between items-center py-1 border-b border-gray-600 last:border-b-0">
                        <span class="text-xs text-gray-300">${formattedDate}</span>
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-white">${entry.weight} kg</span>
                            <span class="${changeClass} text-xs">${changeIcon}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            
            // Actualizar el gr√°fico de peso
            updateWeightChart();
        }

        // --- FUNCIONES DEL GR√ÅFICO DE PESO ---
        let weightChart = null;

        function updateWeightChart() {
            const weightHistory = JSON.parse(localStorage.getItem('weight_history') || '[]');
            const canvas = document.getElementById('weight-chart');
            const messageElement = document.getElementById('weight-chart-message');
            
            if (!canvas) return;

            // Si no hay datos, mostrar mensaje y ocultar gr√°fico
            if (weightHistory.length === 0) {
                canvas.style.display = 'none';
                if (messageElement) {
                    messageElement.style.display = 'block';
                    messageElement.textContent = 'Agrega mediciones de peso para ver el gr√°fico';
                }
                return;
            }

            // Mostrar gr√°fico y ocultar mensaje
            canvas.style.display = 'block';
            if (messageElement) {
                messageElement.style.display = 'none';
            }

            // Preparar datos (√∫ltimos 10 registros, en orden cronol√≥gico)
            const recentHistory = weightHistory.slice(0, 10).reverse();
            const labels = recentHistory.map(entry => {
                const date = new Date(entry.date);
                return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
            });
            const weights = recentHistory.map(entry => entry.weight);

            // Calcular colores basados en tendencia
            const colors = weights.map((weight, index) => {
                if (index === 0) return '#3b82f6'; // Azul para el primer punto
                const previousWeight = weights[index - 1];
                if (weight > previousWeight) return '#ef4444'; // Rojo para aumento
                if (weight < previousWeight) return '#22c55e'; // Verde para disminuci√≥n
                return '#6b7280'; // Gris para sin cambio
            });

            // Destruir gr√°fico anterior si existe
            if (weightChart) {
                weightChart.destroy();
            }

            // Crear nuevo gr√°fico
            const ctx = canvas.getContext('2d');
            weightChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Peso (kg)',
                        data: weights,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color),
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} kg`;
                                },
                                afterLabel: function(context) {
                                    if (context.dataIndex > 0) {
                                        const currentWeight = context.parsed.y;
                                        const previousWeight = weights[context.dataIndex - 1];
                                        const change = currentWeight - previousWeight;
                                        const changeText = change > 0 ? `+${change.toFixed(1)}` : change.toFixed(1);
                                        return `Cambio: ${changeText} kg`;
                                    }
                                    return null;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: Math.min(...weights) - 2,
                            max: Math.max(...weights) + 2,
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return value + ' kg';
                                }
                            },
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Hacer funciones disponibles globalmente
        window.startTodaysWorkout = startTodaysWorkout;
        window.showRoutineSelector = showRoutineSelector;
        window.selectRoutine = selectRoutine;
        window.closeRoutineSelector = closeRoutineSelector;
        window.startTimer = startTimer;
        window.changeCalendarMonth = changeCalendarMonth;
        window.toggleProfileEditor = toggleProfileEditor;
        window.saveUserProfile = saveUserProfile;
        window.addWeightEntry = addWeightEntry;
        
        // --- INICIALIZACI√ìN DE FIREBASE Y AUTH ---
        async function initApp() {
            // setLogLevel('debug'); 

            // Actualizar informaci√≥n del d√≠a actual
            console.log('üìÖ HOY ES:', getDayName().toUpperCase());
            console.log('üéØ TU RUTINA:', getTodaysRoutineName());
            console.log('üí™ ¬°Todo listo para entrenar!');
            updateTodaysRoutineDisplay();

            // Renderizar calendario
            renderCalendar();

            // Cargar perfil de usuario
            loadUserProfile();

            // Diagn√≥stico de variables de entorno
            console.log("=== DIAGN√ìSTICO DE FIREBASE ===");
            console.log("¬ø__app_id definido?", typeof __app_id !== 'undefined');
            console.log("¬ø__firebase_config definido?", typeof __firebase_config !== 'undefined');
            console.log("¬ø__initial_auth_token definido?", typeof __initial_auth_token !== 'undefined');
            console.log("appId:", appId);
            console.log("firebaseConfig:", firebaseConfig);
            console.log("initialAuthToken:", initialAuthToken ? "Definido" : "No definido");
            console.log("==============================");

            // Verificar si la configuraci√≥n de Firebase est√° vac√≠a
            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase Config est√° vac√≠o. El historial y el guardado de progreso no funcionar√°n.");
                 console.warn("SOLUCI√ìN: Este es un entorno local. La app funcionar√° con archivos f√≠sicos.");
                 $loadingSpinner.innerHTML = '<p class="text-yellow-400 font-semibold">Modo local: Usando archivos f√≠sicos</p>';
                 $workoutButtons.classList.remove('hidden');
                 isAuthReady = false;
                 
                 // Usar el sistema de ID mejorado para modo local
                 userId = getUserId();
                 const customId = localStorage.getItem('customUserId');
                 const idType = customId ? ' (personalizado)' : ' (local)';
                 $userIdDisplay.textContent = userId + idType;
                 
                 document.getElementById('loading-history').textContent = 'Cargando desde archivos f√≠sicos...';
                 
                 // Cargar datos desde archivos f√≠sicos
                 loadHistory();
                 loadProgress();
                 
                 return;
            }

            try {
                console.log("Iniciando conexi√≥n a Firebase...");
                app = initializeApp(firebaseConfig);
                console.log("‚úì App Firebase inicializada");
                
                auth = getAuth(app);
                console.log("‚úì Auth Firebase inicializado");
                
                db = getFirestore(app);
                console.log("‚úì Firestore inicializado");

                if (initialAuthToken) {
                    console.log("Autenticando con token personalizado...");
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("‚úì Autenticaci√≥n con token exitosa");
                } else {
                    console.log("Autenticando an√≥nimamente...");
                    await signInAnonymously(auth);
                    console.log("‚úì Autenticaci√≥n an√≥nima exitosa");
                }

                // Usar el sistema de ID mejorado
                userId = getUserId();
                isAuthReady = true;
                
                // Mostrar tipo de ID en la interfaz
                const customId = localStorage.getItem('customUserId');
                const idType = customId ? ' (personalizado)' : ' (Firebase)';
                $userIdDisplay.textContent = userId + idType;
                console.log(`‚úì Usuario autenticado con ID: ${userId}${idType}`);

                // Ocultar spinner y mostrar botones SOLO despu√©s de que isAuthReady es TRUE
                $loadingSpinner.classList.add('hidden');
                $workoutButtons.classList.remove('hidden');


                // 1. Cargar el historial de rutinas completadas
                loadHistory();

                // 2. Cargar el progreso de la rutina actual
                loadProgress();

            } catch (error) {
                console.error("=== ERROR DE FIREBASE ===");
                console.error("Tipo de error:", error.name);
                console.error("Mensaje:", error.message);
                console.error("C√≥digo:", error.code || "N/A");
                console.error("Error completo:", error);
                console.error("========================");
                
                let errorMessage = 'Error de conexi√≥n Firebase';
                
                // Identificar tipo espec√≠fico de error
                if (error.code) {
                    switch (error.code) {
                        case 'auth/network-request-failed':
                            errorMessage = 'Sin conexi√≥n a internet';
                            break;
                        case 'auth/api-key-not-valid':
                            errorMessage = 'Clave API de Firebase inv√°lida';
                            break;
                        case 'firestore/permission-denied':
                            errorMessage = 'Permisos de Firestore denegados';
                            break;
                        case 'auth/project-not-found':
                            errorMessage = 'Proyecto Firebase no encontrado';
                            break;
                        default:
                            errorMessage = `Error Firebase: ${error.code}`;
                    }
                } else if (error.message.includes('fetch')) {
                    errorMessage = 'Error de red - Verifica tu conexi√≥n';
                } else if (error.message.includes('API key')) {
                    errorMessage = 'Clave API Firebase incorrecta';
                }
                
                $loadingSpinner.innerHTML = `<p class="text-red-400 font-semibold">${errorMessage}</p>`;
                $workoutButtons.classList.remove('hidden');
                
                // Usar el sistema de ID mejorado incluso con errores
                userId = getUserId();
                const customId = localStorage.getItem('customUserId');
                const idType = customId ? ' (personalizado)' : ' (local)';
                $userIdDisplay.textContent = userId + idType;
                
                document.getElementById('loading-history').textContent = `Error Firebase - Usando archivos locales`;
                
                // Cargar desde archivos f√≠sicos y localStorage
                loadHistory();
                loadProgress();
            }
        }

        // --- FUNCIONES DE DETALLES DE EJERCICIOS ---
        
        // Funci√≥n para mostrar/ocultar detalles del ejercicio
        window.toggleExerciseDetails = function() {
            const detailsDiv = document.getElementById('exercise-details');
            const showButton = document.getElementById('show-details-button');
            const toggleButton = document.getElementById('toggle-details');
            
            if (detailsDiv.classList.contains('hidden')) {
                // Marcar que fue abierto manualmente
                state.detailsOpenedManually = true;
                
                // Cancelar cualquier auto-cierre programado
                if (state.autoCloseTimeout) {
                    clearTimeout(state.autoCloseTimeout);
                    state.autoCloseTimeout = null;
                }
                
                detailsDiv.classList.remove('hidden');
                showButton.classList.add('hidden');
                toggleButton.textContent = '‚ñ≤ Ocultar Detalles';
            } else {
                // Marcar que fue cerrado manualmente
                state.detailsOpenedManually = false;
                
                detailsDiv.classList.add('hidden');
                showButton.classList.remove('hidden');
                toggleButton.textContent = '‚ñº Ver Detalles';
            }
        }
        
        // Funci√≥n para ocultar los detalles del ejercicio
        window.hideExerciseDetails = function() {
            const detailsDiv = document.getElementById('exercise-details');
            const showButton = document.getElementById('show-details-button');
            const toggleButton = document.getElementById('toggle-details');
            const indicator = document.getElementById('preparation-indicator');
            
            detailsDiv.classList.add('hidden');
            showButton.classList.remove('hidden');
            toggleButton.textContent = '‚ñº Ver Detalles';
            
            // Ocultar tambi√©n el indicador de preparaci√≥n
            if (indicator) {
                indicator.classList.add('hidden');
            }
        }

        // Funci√≥n para actualizar el indicador de progreso
        function updateProgressIndicator() {
            if (!state.isRunning || !$progressText || !state.currentRoutineExercises) return;
            
            const currentStep = state.currentStepIndex + 1;
            const totalSteps = state.currentRoutineExercises.length;
            const currentPhase = state.currentRoutineExercises[state.currentStepIndex]?.phase || '';
            
            // Verificar que tenemos datos v√°lidos
            if (totalSteps === 0 || currentStep <= 0) {
                $progressText.textContent = 'Prepar√°ndose...';
                return;
            }
            
            // Contar ejercicios en la fase actual
            const phaseSteps = state.currentRoutineExercises.filter(step => step.phase === currentPhase && !step.isRest);
            
            if (phaseSteps.length > 0) {
                // Calcular cu√°ntos ejercicios de esta fase hemos completado
                let completedInPhase = 0;
                for (let i = 0; i <= state.currentStepIndex; i++) {
                    const step = state.currentRoutineExercises[i];
                    if (step && step.phase === currentPhase && !step.isRest) {
                        completedInPhase++;
                    }
                }
                
                const phaseProgress = Math.max(1, completedInPhase);
                const phaseTotal = phaseSteps.length;
                $progressText.textContent = `${phaseProgress} de ${phaseTotal} ejercicios ‚Ä¢ Paso ${currentStep}/${totalSteps}`;
            } else {
                $progressText.textContent = `Paso ${currentStep} de ${totalSteps}`;
            }
        }

        // Funci√≥n para actualizar los detalles del ejercicio
        function updateExerciseDetails(exerciseName) {
            const exercise = EXERCISE_DATABASE[exerciseName];
            
            if (!exercise) {
                // Si no hay datos del ejercicio, ocultar todos los detalles
                document.getElementById('exercise-details').classList.add('hidden');
                document.getElementById('show-details-button').classList.add('hidden');
                return;
            }

            // Mostrar el bot√≥n para ver detalles
            document.getElementById('show-details-button').classList.remove('hidden');

            // Actualizar la informaci√≥n b√°sica
            document.getElementById('exercise-category').textContent = exercise.category.toUpperCase();
            document.getElementById('exercise-equipment').textContent = exercise.equipment || 'N/A';
            document.getElementById('exercise-muscles').textContent = exercise.muscles.join(', ');
            document.getElementById('exercise-description').textContent = exercise.description;

            // Actualizar instrucciones
            const instructionsList = document.getElementById('instructions-list');
            instructionsList.innerHTML = '';
            exercise.instructions.forEach(instruction => {
                const li = document.createElement('li');
                li.className = 'text-gray-200';
                li.textContent = instruction;
                instructionsList.appendChild(li);
            });

            // Actualizar tips
            const tipsList = document.getElementById('tips-list');
            tipsList.innerHTML = '';
            exercise.tips.forEach(tip => {
                const li = document.createElement('li');
                li.className = 'text-gray-200';
                li.textContent = tip;
                tipsList.appendChild(li);
            });

            console.log(`‚úÖ Detalles actualizados para: ${exerciseName}`);
        }

        // Funci√≥n para mostrar detalles autom√°ticamente durante el tiempo de preparaci√≥n
        function showExercisePreparation(exerciseName, preparationTime = 10) {
            updateExerciseDetails(exerciseName);
            
            // Determinar si debe mostrar autom√°ticamente (ejercicios "PR√ìXIMO" o durante descansos con "Pr√≥ximo:")
            const shouldShowAuto = exerciseName.includes('PR√ìXIMO') || 
                                  (state.currentRoutineExercises[state.currentStepIndex]?.isRest && 
                                   state.currentRoutineExercises[state.currentStepIndex]?.name.includes('Pr√≥ximo:'));
            
            if (shouldShowAuto) {
                // Mostrar indicador de preparaci√≥n
                const indicator = document.getElementById('preparation-indicator');
                if (indicator) {
                    indicator.classList.remove('hidden');
                }
                
                // Mostrar autom√°ticamente los detalles si hay tiempo de preparaci√≥n y no fueron abiertos manualmente
                if (preparationTime >= 1 && !state.detailsOpenedManually) {
                    const detailsDiv = document.getElementById('exercise-details');
                    const showButton = document.getElementById('show-details-button');
                    
                    detailsDiv.classList.remove('hidden');
                    showButton.classList.add('hidden');
                    
                    // Cancelar timeout anterior si existe
                    if (state.autoCloseTimeout) {
                        clearTimeout(state.autoCloseTimeout);
                    }
                    
                    // Para descansos, mantener abierto todo el tiempo de descanso
                    // Para ejercicios con "PR√ìXIMO", auto-ocultar cerca del final
                    const isRestPeriod = state.currentRoutineExercises[state.currentStepIndex]?.isRest;
                    
                    if (!isRestPeriod && preparationTime > 5) {
                        // Auto-ocultar despu√©s del tiempo de preparaci√≥n (solo si no fue abierto manualmente y no es descanso)
                        state.autoCloseTimeout = setTimeout(() => {
                            // Solo cerrar si no fue abierto manualmente
                            if (!state.detailsOpenedManually && !detailsDiv.classList.contains('hidden')) {
                                detailsDiv.classList.add('hidden');
                                showButton.classList.remove('hidden');
                            }
                            // Ocultar tambi√©n el indicador
                            if (indicator) {
                                indicator.classList.add('hidden');
                            }
                            state.autoCloseTimeout = null;
                        }, (preparationTime - 2) * 1000); // Ocultar 2 segundos antes de que empiece
                    }
                }
            }
        }

        // --- FUNCIONES DE GESTI√ìN DE USUARIO ---
        
        // Funci√≥n para cambiar el ID de usuario
        window.changeUserId = function() {
            const newUserId = document.getElementById('custom-user-id').value.trim();
            
            if (!newUserId) {
                alert('Por favor, ingresa un ID de usuario v√°lido.');
                return;
            }
            
            // Validar formato del ID
            if (!/^[a-zA-Z0-9\-_]{3,20}$/.test(newUserId)) {
                alert('El ID debe tener entre 3 y 20 caracteres y solo puede contener letras, n√∫meros, guiones y guiones bajos.');
                return;
            }
            
            if (confirm(`¬øCambiar tu ID de usuario a "${newUserId}"?\n\n‚ö†Ô∏è Esto crear√° una nueva carpeta de datos.\n\nTus datos actuales permanecer√°n en la carpeta anterior.`)) {
                
                // Guardar el ID personalizado en localStorage
                localStorage.setItem('customUserId', newUserId);
                userId = newUserId;
                
                // Actualizar la interfaz
                $userIdDisplay.textContent = userId + ' (personalizado)';
                document.getElementById('custom-user-id').value = '';
                
                // Recargar historial y progreso con el nuevo ID
                loadHistory();
                loadProgress();
                
                console.log(`‚úÖ ID de usuario cambiado a: ${userId}`);
                alert(`‚úÖ ID cambiado exitosamente a "${userId}"\n\nTus nuevos datos se guardar√°n en:\ndata/users/${userId}/`);
            }
        }
        
        // Funci√≥n para obtener el ID de usuario (con prioridades)
        function getUserId() {
            // 1. ID personalizado guardado
            const customId = localStorage.getItem('customUserId');
            if (customId) {
                return customId;
            }
            
            // 2. ID de Firebase (si est√° disponible)
            if (isAuthReady && auth.currentUser?.uid) {
                return auth.currentUser.uid;
            }
            
            // 3. ID aleatorio generado
            let generatedId = localStorage.getItem('generatedUserId');
            if (!generatedId) {
                generatedId = 'user-' + Math.random().toString(36).substr(2, 8);
                localStorage.setItem('generatedUserId', generatedId);
            }
            
            return generatedId;
        }

        // --- FUNCIONES DE GESTI√ìN DE DATOS JSON ---
        
        // Funci√≥n para descargar datos como archivo JSON
        window.downloadDataAsJSON = async function() {
            try {
                let data = {};
                
                // Intentar obtener datos desde archivos f√≠sicos primero
                try {
                    const physicalData = await loadFromPhysicalFile('getAllData');
                    if (physicalData) {
                        data = physicalData;
                        console.log("‚úÖ Datos obtenidos desde archivos f√≠sicos para descarga");
                    }
                } catch (e) {
                    console.log("‚ö†Ô∏è No se pudieron obtener datos f√≠sicos, usando localStorage");
                }
                
                // Fallback: usar datos de localStorage si no hay f√≠sicos
                if (!data.history && !data.progress) {
                    data = JSON.parse(localStorage.getItem('workout_data') || '{}');
                    console.log("‚ö†Ô∏è Usando datos de localStorage para descarga");
                }

                // Agregar datos del perfil de usuario
                const userProfile = JSON.parse(localStorage.getItem('user_profile') || '{}');
                const weightHistory = JSON.parse(localStorage.getItem('weight_history') || '[]');
                
                if (Object.keys(userProfile).length > 0) {
                    data.user_profile = userProfile;
                }
                
                if (weightHistory.length > 0) {
                    data.weight_history = weightHistory;
                }
                
                // Agregar metadatos de exportaci√≥n
                data.exportDate = new Date().toISOString();
                data.appVersion = "1.0.0";
                data.exportedBy = userId;
                data.source = data.history || data.progress ? "Archivo F√≠sico" : "localStorage";
                
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `workout-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log("‚úÖ Datos descargados como JSON desde:", data.source);
                alert(`¬°Datos descargados exitosamente!\nFuente: ${data.source}`);
                
            } catch (e) {
                console.error("‚ùå Error descargando datos:", e);
                alert("Error al descargar datos: " + e.message);
            }
        }

        // Funci√≥n para manejar la importaci√≥n de archivos JSON
        window.handleJSONImport = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const data = await importDataFromJSON(file);
                
                // Actualizar interfaz
                loadHistory();
                loadProgress();
                loadUserProfile();
                
                const profileCount = Object.keys(data.user_profile || {}).length;
                const weightCount = (data.weight_history || []).length;
                
                alert(`¬°Datos importados exitosamente!\n\nHistorial: ${Object.keys(data.history || {}).length} entradas\nProgreso: ${data.progress ? 'Disponible' : 'No disponible'}\nPerfil: ${profileCount > 0 ? 'Importado' : 'No disponible'}\nPeso: ${weightCount} registros`);
                
                // Limpiar el input
                event.target.value = '';
                
            } catch (e) {
                alert("Error importando archivo: " + e.message);
            }
        }

        // Funci√≥n para importar datos desde archivo JSON
        function importDataFromJSON(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Validar estructura del archivo
                        if (!data.exportDate && !data.history && !data.progress) {
                            throw new Error("Formato de archivo inv√°lido. Debe ser un archivo de datos de entrenamiento.");
                        }
                        
                        // Guardar en localStorage
                        localStorage.setItem('workout_data', JSON.stringify(data, null, 2));
                        
                        // Si hay progreso, tambi√©n guardarlo separadamente
                        if (data.progress) {
                            localStorage.setItem('workout_progress', JSON.stringify(data.progress));
                        }

                        // Si hay perfil de usuario, guardarlo
                        if (data.user_profile) {
                            localStorage.setItem('user_profile', JSON.stringify(data.user_profile));
                        }

                        // Si hay historial de peso, guardarlo
                        if (data.weight_history) {
                            localStorage.setItem('weight_history', JSON.stringify(data.weight_history));
                        }
                        
                        console.log("‚úÖ Datos importados exitosamente:", data);
                        resolve(data);
                        
                    } catch (error) {
                        console.error("‚ùå Error importando datos:", error);
                        reject(error);
                    }
                };
                reader.readAsText(file);
            });
        }

        // Funci√≥n para limpiar todos los datos locales
        window.clearAllData = function() {
            if (confirm("‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar TODOS los datos locales?\n\nEsto incluye:\n- Historial de entrenamientos\n- Progreso guardado\n- Perfil de usuario\n- Historial de peso\n- Toda la informaci√≥n almacenada\n\nEsta acci√≥n NO se puede deshacer.")) {
                try {
                    localStorage.removeItem('workout_data');
                    localStorage.removeItem('workout_progress');
                    localStorage.removeItem('user_profile');
                    localStorage.removeItem('weight_history');
                    
                    // Actualizar interfaz
                    $historyList.innerHTML = '<p class="text-gray-400">¬°A√∫n no has completado ninguna rutina! ¬°Empieza hoy!</p>';
                    loadUserProfile(); // Recargar perfil vac√≠o
                    renderCalendar(); // Actualizar calendario
                    
                    console.log("‚úÖ Todos los datos locales han sido eliminados");
                    alert("‚úÖ Datos eliminados exitosamente.");
                    
                } catch (e) {
                    console.error("‚ùå Error eliminando datos:", e);
                    alert("Error eliminando datos: " + e.message);
                }
            }
        }

        // --- FUNCI√ìN DE PRUEBA DE CONECTIVIDAD ---
        window.testFirebaseConnection = async function() {
            console.log("=== PRUEBA DE CONECTIVIDAD FIREBASE ===");
            
            const testResults = [];
            
            // 1. Verificar configuraci√≥n
            testResults.push(`‚úÖ Config cargada: ${Object.keys(firebaseConfig).length > 0 ? 'S√≠' : 'No'}`);
            testResults.push(`‚úÖ App ID: ${appId}`);
            testResults.push(`‚úÖ Auth Ready: ${isAuthReady}`);
            testResults.push(`‚úÖ User ID: ${userId}`);
            
            // 2. Verificar datos locales
            const localData = localStorage.getItem('workout_data');
            const progressData = localStorage.getItem('workout_progress');
            testResults.push(`‚úÖ Datos JSON locales: ${localData ? 'Disponibles' : 'No disponibles'}`);
            testResults.push(`‚úÖ Progreso local: ${progressData ? 'Disponible' : 'No disponible'}`);
            
            // 3. Probar sistema de archivos f√≠sicos
            try {
                const physicalTest = await fetch('./api/data_handler.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId, action: 'loadProgress' })
                });
                const physicalResult = await physicalTest.json();
                testResults.push(`‚úÖ Archivos f√≠sicos PHP: ${physicalResult.success ? 'Funcionando' : 'Error'}`);
                if (!physicalResult.success) {
                    testResults.push(`   ‚îî‚îÄ Error: ${physicalResult.message}`);
                }
            } catch (e) {
                testResults.push(`‚ùå Archivos f√≠sicos PHP: No disponible - ${e.message}`);
            }
            
            // 4. Probar conectividad de red
            try {
                const networkTest = await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' });
                testResults.push(`‚úÖ Conectividad de red: OK`);
            } catch (e) {
                testResults.push(`‚ùå Conectividad de red: FALLA`);
            }
            
            // 5. Probar Firebase si est√° configurado
            if (Object.keys(firebaseConfig).length > 0 && isAuthReady) {
                try {
                    const testDocRef = doc(db, 'test', 'connectivity');
                    const testDoc = await getDoc(testDocRef);
                    testResults.push(`‚úÖ Firestore: Conectado`);
                } catch (e) {
                    testResults.push(`‚ùå Firestore: Error - ${e.code || e.message}`);
                }
            } else {
                testResults.push(`‚ö†Ô∏è  Firebase: No configurado`);
            }
            
            // Mostrar resultados
            const results = testResults.join('\n');
            console.log(results);
            alert(`RESULTADOS DE CONECTIVIDAD:\n\n${results}`);
            console.log("=====================================");
        }

        window.onload = initApp;

    </script>
</body>
</html>
